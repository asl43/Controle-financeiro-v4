<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro - Versão Moderna</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* ============================================
   VARIÁVEIS E FUNDAMENTOS
   ============================================ */
:root {
    --bg-gradient-dark: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    --bg-gradient-light: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --card-bg-dark: rgba(255, 255, 255, 0.05);
    --card-bg-light: #ffffff;
    --text-dark: #e0e0e0;
    --text-light: #2c3e50;
    --primary: #667eea;
    --primary-hover: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    --border-dark: rgba(255, 255, 255, 0.1);
    --border-light: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

html[data-theme="light"] {
    --bg-gradient-dark: var(--bg-gradient-light);
    --card-bg-dark: var(--card-bg-light);
    --text-dark: var(--text-light);
    --border-dark: var(--border-light);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg-gradient-dark);
    color: var(--text-dark);
    line-height: 1.6;
    min-height: 100vh;
    transition: var(--transition);
}

/* ============================================
   SCROLLBAR CUSTOMIZADA
   ============================================ */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-hover);
}

/* ============================================
   HEADER E NAVEGAÇÃO
   ============================================ */
.header {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: var(--card-bg-dark);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-dark);
    padding: 1rem 0;
    box-shadow: var(--shadow-md);
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.theme-toggle {
    background: var(--card-bg-dark);
    border: 1px solid var(--border-dark);
    color: var(--text-dark);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.theme-toggle:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.sync-badge {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid var(--success);
    color: var(--success);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-lg);
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sync-badge.offline {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--danger);
    color: var(--danger);
}

.pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* ============================================
   CONTAINER E LAYOUT
   ============================================ */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
}

.section {
    margin-bottom: 2rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* ============================================
   CARDS DE RESUMO
   ============================================ */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.card {
    background: var(--card-bg-dark);
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    transition: var(--transition);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--primary-hover));
    opacity: 0;
    transition: var(--transition);
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary);
}

.card:hover::before {
    opacity: 1;
}

.card-label {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-dark);
    opacity: 0.7;
    margin-bottom: 0.75rem;
}

.card-value {
    font-size: 2rem;
    font-weight: 800;
    line-height: 1.2;
}

.card-subtitle {
    font-size: 0.875rem;
    margin-top: 0.75rem;
    opacity: 0.8;
}

.card-pagar .card-value { color: var(--danger); }
.card-receber .card-value { color: var(--success); }
.card-saldo .card-value { color: var(--info); }
.card-meta .card-value { color: var(--warning); }

.progress-bar {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    margin-top: 1rem;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--info));
    border-radius: 10px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-fill.warning { background: linear-gradient(90deg, var(--warning), var(--danger)); }
.progress-fill.danger { background: var(--danger); }

.edit-hint {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 0.75rem;
    color: var(--primary);
    opacity: 0;
    transition: var(--transition);
}

.card:hover .edit-hint {
    opacity: 1;
}

/* ============================================
   GRID DE CONTEÚDO
   ============================================ */
.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.panel {
    background: var(--card-bg-dark);
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    backdrop-filter: blur(10px);
}

.panel-header {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* ============================================
   FORMULÁRIO
   ============================================ */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

input, select, textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-md);
    color: var(--text-dark);
    font-size: 1rem;
    transition: var(--transition);
    font-family: inherit;
}

html[data-theme="light"] input,
html[data-theme="light"] select,
html[data-theme="light"] textarea {
    background: #ffffff;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: rgba(102, 126, 234, 0.1);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* ============================================
   BOTÕES
   ============================================ */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    color: white;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.btn-block {
    width: 100%;
}

/* ============================================
   FILTROS
   ============================================ */
.filters-container {
    background: var(--card-bg-dark);
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filter-tabs {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-dark);
}

.filter-tab {
    padding: 0.625rem 1.25rem;
    background: transparent;
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-lg);
    color: var(--text-dark);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-tab:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: var(--primary);
}

.filter-tab.active {
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    border-color: transparent;
    color: white;
}

.filter-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.search-wrapper {
    position: relative;
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dark);
    opacity: 0.5;
}

.search-input {
    padding-left: 2.5rem;
}

/* ============================================
   TABELA
   ============================================ */
.table-container {
    overflow-x: auto;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-dark);
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9375rem;
}

thead {
    background: rgba(102, 126, 234, 0.1);
    position: sticky;
    top: 0;
    z-index: 10;
}

th {
    padding: 1rem;
    text-align: left;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.75rem;
    color: var(--text-dark);
    border-bottom: 2px solid var(--border-dark);
}

td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-dark);
}

tr:hover {
    background: rgba(102, 126, 234, 0.05);
}

.badge {
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-lg);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: inline-block;
    cursor: pointer;
    transition: var(--transition);
}

.badge:hover {
    transform: scale(1.05);
}

.badge-pagar {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.badge-receber {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.badge-pendente {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.badge-pago {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.star {
    font-size: 1.25rem;
    cursor: pointer;
    transition: var(--transition);
    filter: grayscale(1);
}

.star:hover,
.star.active {
    filter: grayscale(0);
    transform: scale(1.2);
}

/* ============================================
   FAB (Floating Action Button)
   ============================================ */
.fab-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 999;
}

.fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    color: white;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    box-shadow: var(--shadow-xl);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
}

.fab:hover {
    transform: scale(1.1) rotate(90deg);
}

.quick-menu {
    position: absolute;
    bottom: 80px;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    opacity: 0;
    pointer-events: none;
    transform: translateY(20px);
    transition: var(--transition);
}

.quick-menu.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}

.quick-menu .btn {
    width: 180px;
    box-shadow: var(--shadow-lg);
}

/* ============================================
   MODAL DE LOGIN
   ============================================ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 1rem;
}

.modal-content {
    background: var(--card-bg-dark);
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-lg);
    padding: 2.5rem;
    max-width: 400px;
    width: 100%;
    box-shadow: var(--shadow-xl);
    backdrop-filter: blur(20px);
}

.modal-header {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.modal-description {
    color: var(--text-dark);
    opacity: 0.7;
    margin-bottom: 2rem;
}

.error-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 0.75rem;
    border-radius: var(--radius-md);
    margin-top: 1rem;
    font-weight: 600;
    text-align: center;
}

/* ============================================
   LOADING
   ============================================ */
.loading {
    display: none;
    text-align: center;
    padding: 1rem;
    color: var(--primary);
    font-weight: 600;
}

.loading.show {
    display: block;
}

.loading::after {
    content: '⏳';
    animation: rotate 1s linear infinite;
    display: inline-block;
    margin-left: 0.5rem;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ============================================
   CALENDÁRIO
   ============================================ */
.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    font-size: 0.875rem;
}

.calendar-header {
    font-weight: 700;
    text-align: center;
    padding: 0.75rem;
    color: var(--primary);
}

.calendar-day {
    aspect-ratio: 1;
    border: 1px solid var(--border-dark);
    border-radius: var(--radius-sm);
    padding: 0.5rem;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.02);
}

.calendar-day:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: var(--primary);
}

.calendar-day.has-events {
    border-color: var(--primary);
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
}

.day-number {
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.day-amount {
    font-size: 0.75rem;
    font-weight: 600;
}

.day-pagar { color: var(--danger); }
.day-receber { color: var(--success); }

/* ============================================
   RESPONSIVIDADE
   ============================================ */
@media (max-width: 1024px) {
    .content-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-actions {
        justify-content: space-between;
    }
    
    .cards-grid {
        grid-template-columns: 1fr;
    }
    
    .content-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-grid {
        grid-template-columns: 1fr;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .card-value {
        font-size: 1.5rem;
    }
    
    .fab-container {
        bottom: 1rem;
        right: 1rem;
    }
    
    .fab {
        width: 56px;
        height: 56px;
    }
    
    table {
        font-size: 0.875rem;
    }
    
    th, td {
        padding: 0.75rem 0.5rem;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 1rem;
    }
    
    .panel {
        padding: 1rem;
    }
    
    .card {
        padding: 1rem;
    }
    
    th, td {
        padding: 0.5rem 0.25rem;
        font-size: 0.75rem;
    }
    
    .actions {
        flex-direction: column;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }
}

/* ============================================
   MODO COMPACTO
   ============================================ */
.table-compact th,
.table-compact td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

.table-compact .badge {
    padding: 0.25rem 0.5rem;
    font-size: 0.625rem;
}

/* ============================================
   UTILITÁRIOS
   ============================================ */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
</style>
</head>
<body>

<!-- MODAL DE LOGIN -->
<div class="modal-overlay" id="loginOverlay">
    <div class="modal-content">
        <h2 class="modal-header">🔐 Acesso Restrito</h2>
        <p class="modal-description">Digite sua senha para acessar o sistema</p>
        <input type="password" id="senhaInput" placeholder="Digite sua senha" onkeypress="if(event.key==='Enter') fazerLogin()">
        <button class="btn btn-primary btn-block mt-2" onclick="fazerLogin()">🔓 Entrar</button>
        <div class="error-message hidden" id="erroSenha"></div>
    </div>
</div>

<!-- CONTEÚDO PRINCIPAL -->
<div id="mainContainer" class="hidden">
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                💰 Controle Financeiro
            </div>
            <div class="header-actions">
                <div class="sync-badge" id="syncStatus">
                    <div class="pulse-dot"></div>
                    <span id="syncText">Sincronizado</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">☀️</span>
                    <span id="themeText">Modo Claro</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- LOADING -->
        <div class="loading" id="loading">Sincronizando dados...</div>

        <!-- CARDS DE RESUMO -->
        <section class="section">
            <div class="cards-grid">
                <div class="card card-pagar">
                    <div class="card-label">Total a Pagar</div>
                    <div class="card-value" id="totalPagar">R$ 0,00</div>
                </div>
                
                <div class="card card-receber">
                    <div class="card-label">Total a Receber</div>
                    <div class="card-value" id="totalReceber">R$ 0,00</div>
                </div>
                
                <div class="card card-saldo">
                    <div class="card-label">Saldo do Dia</div>
                    <div class="card-value" id="totalDia">R$ 0,00</div>
                </div>
                
                <div class="card card-pagar">
                    <div class="card-label">Contas Vencidas</div>
                    <div class="card-value" id="totalVencidos">R$ 0,00</div>
                </div>
                
                <div class="card card-pagar">
                    <div class="card-label">Vencem 7 Dias</div>
                    <div class="card-value" id="vencemSeteDias">R$ 0,00</div>
                </div>
                
                <div class="card card-pagar">
                    <div class="card-label">Gasto Hoje</div>
                    <div class="card-value" id="gastoHoje">R$ 0,00</div>
                </div>
                
                <div class="card" id="cardSobraMes">
                    <div class="card-label">Sobra/Falta (Mês)</div>
                    <div class="card-value" id="sobraFaltaMes">R$ 0,00</div>
                    <div class="card-subtitle">Média 3M: <span id="media3Meses">R$ 0,00</span></div>
                </div>
                
                <div class="card card-meta" onclick="editarMeta('global')" style="cursor: pointer;">
                    <div class="edit-hint">✏️ Clique para editar</div>
                    <div class="card-label" id="metaLabel">Meta de Gastos (Mês)</div>
                    <div class="card-value" id="metaValor">R$ 0,00</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="metaProgress"></div>
                    </div>
                    <div class="card-subtitle" id="metaPercentual">0% utilizado</div>
                </div>
            </div>
        </section>

        <!-- FORMULÁRIO E GRÁFICOS -->
        <section class="section">
            <div class="content-grid">
                <!-- FORMULÁRIO -->
                <div class="panel">
                    <div class="panel-header">📝 Novo Registro</div>
                    <form id="financeForm">
                        <input type="hidden" id="row">
                        <input type="hidden" id="sheetRowId">
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="data">Data</label>
                                <input type="date" id="data" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="tipo">Tipo</label>
                                <select id="tipo" required onchange="toggleParcelaRecorrente()">
                                    <option value="Pagar">Pagar</option>
                                    <option value="Receber">Receber</option>
                                </select>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="descricao">Descrição</label>
                                <input type="text" id="descricao" placeholder="Ex: Aluguel, Salário..." required>
                            </div>
                            
                            <div class="form-group">
                                <label for="categoria">Categoria</label>
                                <select id="categoria" required>
                                    <option value="">Selecione</option>
                                    <option value="Salário/Renda">Salário/Renda</option>
                                    <option value="Investimento">Investimento</option>
                                    <option value="Alimentação">Alimentação</option>
                                    <option value="Moradia/Aluguel">Moradia/Aluguel</option>
                                    <option value="Transporte">Transporte</option>
                                    <option value="Lazer">Lazer</option>
                                    <option value="Saúde">Saúde</option>
                                    <option value="Educação">Educação</option>
                                    <option value="Outros">Outros</option>
                                </select>
                                <div id="categoryMetaIndicator" style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--warning);"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="valor">Valor</label>
                                <input type="number" id="valor" placeholder="0,00" required step="0.01">
                            </div>
                            
                            <div class="form-group hidden" id="parcelamentoGroup">
                                <label for="parcelas">Parcelas</label>
                                <input type="number" id="parcelas" placeholder="1" min="1" value="1" onchange="toggleParcelaRecorrente()">
                            </div>
                            
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" required>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Pago">Pago</option>
                                    <option value="Recebido">Recebido</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="conta">Conta/Carteira</label>
                                <select id="conta">
                                    <option value="Conta Corrente">Conta Corrente</option>
                                    <option value="Poupança">Poupança</option>
                                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                                    <option value="Carteira">Carteira (Dinheiro)</option>
                                </select>
                            </div>
                            
                            <div class="form-group hidden" id="recorrenciaGroup">
                                <label for="recorrencia">Recorrente</label>
                                <select id="recorrencia">
                                    <option value="Nao">Não</option>
                                    <option value="Sim">Sim, Mensal</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="campo2">Campo Extra 2</label>
                                <input type="text" id="campo2" placeholder="Opcional">
                            </div>
                            
                            <div class="form-group">
                                <label for="campo3">Campo Extra 3</label>
                                <input type="text" id="campo3" placeholder="Opcional">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block mt-2">💾 Salvar Registro</button>
                    </form>
                </div>

                <!-- GRÁFICO DE CATEGORIAS -->
                <div class="panel">
                    <div class="panel-header">📊 Gastos por Categoria</div>
                    <canvas id="graficoTipo" style="max-height: 300px;"></canvas>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto;">
                        <h4 style="font-size: 0.875rem; margin-bottom: 1rem; color: var(--warning);">Metas por Categoria</h4>
                        <div id="categoryMetasSummary">
                            <div style="text-align: center; color: var(--text-dark); opacity: 0.5;">
                                Clique em "Meta de Gastos" acima para configurar
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- GRÁFICOS ADICIONAIS -->
        <section class="section">
            <div class="content-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
                <div class="panel">
                    <div class="panel-header">📈 Fluxo de Caixa</div>
                    <canvas id="graficoFluxoCaixa" style="max-height: 250px;"></canvas>
                </div>
                
                <div class="panel">
                    <div class="panel-header">📉 Comparativo Mensal</div>
                    <canvas id="graficoComparativoMensal" style="max-height: 250px;"></canvas>
                </div>
                
                <div class="panel card-meta" onclick="editarMeta('objetivo')" style="cursor: pointer;">
                    <div class="edit-hint">✏️ Clique para editar</div>
                    <div class="panel-header">🎯 Objetivo de Economia</div>
                    <div id="objetivoCardContent">
                        <p style="color: var(--success); font-weight: 600; margin-bottom: 1rem;">
                            Meta: <span id="objetivoValorDisplay">R$ 0,00</span> em <span id="objetivoMesesDisplay">0</span> meses
                        </p>
                        <p style="font-size: 1.5rem; font-weight: 700; text-align: center;">
                            <span id="valorMensalPoupar" style="color: var(--success);">R$ 0,00/mês</span>
                        </p>
                        <div style="font-size: 0.875rem; color: var(--text-dark); opacity: 0.7; text-align: center; margin-top: 0.5rem;">
                            Baseado em <span id="objetivoMesesAux">0</span> meses
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- FILTROS E TABELA -->
        <section class="section">
            <div class="panel">
                <div class="panel-header">📋 Registros Financeiros</div>
                
                <!-- FILTROS POR STATUS -->
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filtrarPorStatus('todos')">
                        🔍 Todos <span class="filter-count" id="countTodos">0</span>
                    </button>
                    <button class="filter-tab" onclick="filtrarPorStatus('Pendente')">
                        ⏳ Pendentes <span class="filter-count" id="countPendente">0</span>
                    </button>
                    <button class="filter-tab" onclick="filtrarPorStatus('Pago')">
                        ✅ Pagos <span class="filter-count" id="countPago">0</span>
                    </button>
                    <button class="filter-tab" onclick="filtrarPorStatus('Recebido')">
                        💰 Recebidos <span class="filter-count" id="countRecebido">0</span>
                    </button>
                    <button class="filter-tab" onclick="filtrarPorStatus('tipo-pagar')">
                        💸 A Pagar <span class="filter-count" id="countPagar">0</span>
                    </button>
                    <button class="filter-tab" onclick="filtrarPorStatus('tipo-receber')">
                        💵 A Receber <span class="filter-count" id="countReceber">0</span>
                    </button>
                </div>
                
                <!-- FILTROS AVANÇADOS -->
                <div class="filter-grid">
                    <div class="search-wrapper">
                        <span class="search-icon">🔍</span>
                        <input type="text" id="buscar" class="search-input" placeholder="Buscar descrição, categoria, conta...">
                    </div>
                    
                    <div>
                        <label for="filtroCategoria">Categoria</label>
                        <select id="filtroCategoria" onchange="aplicarFiltros()">
                            <option value="all">Todas</option>
                            <option value="Salário/Renda">Salário/Renda</option>
                            <option value="Investimento">Investimento</option>
                            <option value="Alimentação">Alimentação</option>
                            <option value="Moradia/Aluguel">Moradia/Aluguel</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Lazer">Lazer</option>
                            <option value="Saúde">Saúde</option>
                            <option value="Educação">Educação</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="filtroPeriodo">Período</label>
                        <select id="filtroPeriodo">
                            <option value="all">Todos</option>
                            <option value="1" selected>Dia Atual</option>
                            <option value="2-30">Últimos 30 Dias</option>
                            <option value="90">Últimos 90 Dias</option>
                            <option value="customDays">Customizado</option>
                        </select>
                    </div>
                    
                    <div id="customDaysInput" class="hidden">
                        <label for="diasCustomizados">Dias Retroativos</label>
                        <input type="number" id="diasCustomizados" placeholder="Ex: 250">
                    </div>
                    
                    <div>
                        <label for="dataInicio">Data Início</label>
                        <input type="date" id="dataInicio">
                    </div>
                    
                    <div>
                        <label for="dataFim">Data Fim</label>
                        <input type="date" id="dataFim">
                    </div>
                </div>
                
                <!-- BOTÕES DE AÇÃO -->
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button class="btn btn-primary btn-sm" id="btnFiltrarData">Filtrar Customizado</button>
                    <button class="btn btn-outline btn-sm" id="btnFiltrarFav">⭐ Favoritos</button>
                    <button class="btn btn-outline btn-sm" onclick="toggleCompactMode(this)">↔️ Modo Compacto</button>
                    <button class="btn btn-success btn-sm" onclick="exportarExcel()">📥 Excel</button>
                    <button class="btn btn-danger btn-sm" onclick="alert('PDF em desenvolvimento!')">🖨️ PDF</button>
                </div>
                
                <!-- RESUMO DO FILTRO -->
                <div id="periodSummary" class="hidden" style="margin-top: 1rem; padding: 1rem; background: rgba(102,126,234,0.1); border: 1px solid var(--primary); border-radius: var(--radius-md); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 1rem;">
                    <span>Total Pagar: <strong style="color: var(--danger);" id="summaryPagar"></strong></span>
                    <span>Total Receber: <strong style="color: var(--success);" id="summaryReceber"></strong></span>
                    <span>Saldo: <strong style="color: var(--info);" id="summarySaldo"></strong></span>
                </div>
                
                <!-- TABELA -->
                <div class="table-container" style="margin-top: 1.5rem;">
                    <table id="tabelaFinance">
                        <thead>
                            <tr>
                                <th>★</th>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Conta</th>
                                <th>Status</th>
                                <th>Extras</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- GRÁFICOS DIÁRIO E MENSAL -->
        <section class="section">
            <div class="content-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
                <div class="panel">
                    <div class="panel-header">📈 Gastos Diários (7 dias)</div>
                    <canvas id="graficoDiario" style="max-height: 250px;"></canvas>
                </div>
                
                <div class="panel">
                    <div class="panel-header">📉 Gastos Mensais por Categoria</div>
                    <canvas id="graficoMensal" style="max-height: 250px;"></canvas>
                </div>
                
                <div class="panel">
                    <div class="panel-header">📅 Calendário Financeiro</div>
                    <div id="calendarHeader" style="text-align: center; font-weight: 700; margin-bottom: 1rem;">Mês/Ano</div>
                    <div class="calendar" id="financialCalendar"></div>
                    <div style="font-size: 0.75rem; color: var(--text-dark); opacity: 0.7; margin-top: 1rem; text-align: center;">
                        * Clique nos dias para ver detalhes
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- FAB (Floating Action Button) -->
<div class="fab-container hidden" id="fabContainer">
    <div class="quick-menu" id="quickMenu">
        <button class="btn btn-success" onclick="focarFormulario('Receber')">💵 Novo Recebimento</button>
        <button class="btn btn-danger" onclick="focarFormulario('Pagar')">💸 Novo Pagamento</button>
    </div>
    <button class="fab" onclick="toggleQuickMenu()">+</button>
</div>

<script>
// ============================================
// VARIÁVEIS GLOBAIS
// ============================================
let registros = [];
let chart, chartDiario, chartMensal, chartFluxoCaixa, chartCompMensal;
let mostraApenasFav = false;
let usuarioAutenticado = false;
let currentTheme = localStorage.getItem('theme') || 'dark';
let filtroStatusAtual = 'todos';
let filtroCategoriaAtual = 'all';

let metasPorCategoria = JSON.parse(localStorage.getItem('metasPorCategoria')) || {
    "Alimentação": 800,
    "Moradia/Aluguel": 1500,
    "Transporte": 300
};

let objetivoEconomia = parseFloat(localStorage.getItem('objetivoEconomia')) || 10000;
let objetivoMeses = parseInt(localStorage.getItem('objetivoMeses')) || 12;
let metaTipo = localStorage.getItem('metaTipo') || 'mensal';
let metaValor = parseFloat(localStorage.getItem('metaValor')) || 5000;

const regrasAutomacao = [
    { termo: "uber", categoria: "Transporte" },
    { termo: "ifood", categoria: "Alimentação" },
    { termo: "netflix", categoria: "Lazer" },
    { termo: "aluguel", categoria: "Moradia/Aluguel" }
];

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx4Ng3BXxgOuDIZ-P-9i7KFVheEZ1K30s-4p3-1NOFZnBxQZTiBw96otqfpOxaeeoY/exec";
const SENHA_ACESSO = "nanl250612";

// ============================================
// FUNÇÕES UTILITÁRIAS
// ============================================
const formatarMoeda = valor => new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(valor);

function corrigirData(dataInput) {
    const data = new Date(dataInput + 'T12:00:00');
    const ano = data.getFullYear();
    const mes = String(data.getMonth() + 1).padStart(2, '0');
    const dia = String(data.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
}

function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
    applyTheme();
}

function applyTheme() {
    document.documentElement.setAttribute('data-theme', currentTheme);
    document.getElementById('themeIcon').innerText = currentTheme === 'light' ? '🌙' : '☀️';
    document.getElementById('themeText').innerText = currentTheme === 'light' ? 'Modo Escuro' : 'Modo Claro';
    if(chart) atualizarGraficos(registros);
}

function mostrarLoading(show) {
    document.getElementById("loading").classList.toggle("show", show);
}

function atualizarStatusSync(sincronizado) {
    const status = document.getElementById("syncStatus");
    const text = document.getElementById("syncText");
    
    if(sincronizado) {
        status.classList.remove("offline");
        text.innerText = "✓ Sincronizado";
    } else {
        status.classList.add("offline");
        text.innerText = "⚠ Offline";
    }
}

// ============================================
// AUTENTICAÇÃO
// ============================================
function fazerLogin() {
    const senha = document.getElementById("senhaInput").value;
    const erroDiv = document.getElementById("erroSenha");
    
    if(senha === SENHA_ACESSO) {
        usuarioAutenticado = true;
        sessionStorage.setItem("autenticado", "true");
        document.getElementById("loginOverlay").classList.add("hidden");
        document.getElementById("mainContainer").classList.remove("hidden");
        document.getElementById("fabContainer").classList.remove("hidden");
        carregarRegistros();
        erroDiv.classList.add("hidden");
    } else {
        erroDiv.innerText = "❌ Senha incorreta! Tente novamente.";
        erroDiv.classList.remove("hidden");
        document.getElementById("senhaInput").value = "";
    }
}

function verificarAutenticacao() {
    if(sessionStorage.getItem("autenticado") === "true") {
        usuarioAutenticado = true;
        document.getElementById("loginOverlay").classList.add("hidden");
        document.getElementById("mainContainer").classList.remove("hidden");
        document.getElementById("fabContainer").classList.remove("hidden");
    }
}

// ============================================
// COMUNICAÇÃO COM APPS SCRIPT
// ============================================
async function enviarParaPlanilha(dados) {
    mostrarLoading(true);
    try {
        // Adiciona a senha em todas as requisições
        dados.senha = SENHA_ACESSO;
        
        const resp = await fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para Apps Script
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        // Como usamos no-cors, não conseguimos ler a resposta
        // Mas sabemos que foi enviado com sucesso
        atualizarStatusSync(true);
        mostrarLoading(false);
        
        // Aguarda um pouco e recarrega os dados
        setTimeout(() => carregarRegistros(), 500);
        
        return { sucesso: true };
    } catch(e) {
        console.error("Erro ao sincronizar:", e);
        atualizarStatusSync(false);
        mostrarLoading(false);
        alert("⚠️ Erro ao sincronizar. Verifique sua conexão.");
        return { erro: e.toString() };
    }
}

async function carregarRegistros() {
    mostrarLoading(true);
    try {
        const resp = await fetch(WEB_APP_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: {
                'Content-Type': 'text/plain'
            },
            body: JSON.stringify({
                action: 'get',
                senha: SENHA_ACESSO
            })
        });
        
        const data = await resp.json();
        
        if(Array.isArray(data)) {
            registros = data.map((r, idx) => ({
                ...r,
                row: idx + 1,
                fav: r.fav || false,
                categoria: r.categoria || r.campo1 || 'Outros',
                conta: r.conta || 'Conta Corrente',
                recorrente: r.recorrente || 'Nao',
                parcelaAtual: parseInt(r.parcelaAtual) || 1,
                parcelaTotal: parseInt(r.parcelaTotal) || 1,
                valorOriginal: r.valorOriginal ? parseFloat(r.valorOriginal) : null
            }));
            atualizarStatusSync(true);
            aplicarFiltros();
            console.log("✓ Carregados " + registros.length + " registros da planilha");
        } else if(data.erro) {
            console.error("Erro do servidor:", data.erro);
            atualizarStatusSync(false);
            alert("⚠️ Erro: " + data.erro);
        }
    } catch(e) {
        console.error("Erro ao carregar:", e);
        atualizarStatusSync(false);
        alert("⚠️ Erro ao carregar dados. Verifique:\n1. Se a URL do Apps Script está correta\n2. Se o Web App foi implantado corretamente\n3. Se tem acesso à internet");
    }
    mostrarLoading(false);
}

// ============================================
// CÁLCULOS E CARDS
// ============================================
function atualizarCardMeta(gastoHoje, gastoMes) {
    const label = metaTipo === 'diario' ? 'Meta de Gastos (Dia)' : 'Meta de Gastos (Mês)';
    const gastoAtual = metaTipo === 'diario' ? gastoHoje : gastoMes;
    const percentual = metaValor > 0 ? (gastoAtual / metaValor * 100) : 0;
    
    document.getElementById("metaLabel").innerText = label;
    document.getElementById("metaValor").innerText = formatarMoeda(metaValor);
    document.getElementById("metaPercentual").innerText = `${percentual.toFixed(1)}% utilizado (${formatarMoeda(gastoAtual)} de ${formatarMoeda(metaValor)})`;
    
    const progressBar = document.getElementById("metaProgress");
    progressBar.style.width = Math.min(percentual, 100) + '%';
    
    progressBar.className = 'progress-fill';
    if(percentual >= 90) progressBar.classList.add('danger');
    else if(percentual >= 70) progressBar.classList.add('warning');
}

function atualizarCardObjetivo() {
    const valorMensalNecessario = objetivoMeses > 0 ? objetivoEconomia / objetivoMeses : 0;
    document.getElementById("objetivoValorDisplay").innerText = formatarMoeda(objetivoEconomia);
    document.getElementById("objetivoMesesDisplay").innerText = objetivoMeses;
    document.getElementById("objetivoMesesAux").innerText = objetivoMeses;
    document.getElementById("valorMensalPoupar").innerText = formatarMoeda(valorMensalNecessario) + "/mês";
}

function atualizarCategoryMetas(dataList) {
    const summaryDiv = document.getElementById("categoryMetasSummary");
    summaryDiv.innerHTML = '';
    
    const gastosMesPorCategoria = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago")
        .reduce((acc, r) => {
            const dataRegistro = new Date(r.data + 'T12:00:00');
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();
            if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual) {
                acc[r.categoria] = (acc[r.categoria] || 0) + parseFloat(r.valor);
            }
            return acc;
        }, {});

    const categoriasComMeta = Object.keys(metasPorCategoria).sort();

    if(categoriasComMeta.length === 0) {
        summaryDiv.innerHTML = '<div style="text-align: center; color: var(--text-dark); opacity: 0.5;">Clique em "Meta de Gastos" para configurar</div>';
        return;
    }

    categoriasComMeta.forEach(cat => {
        const meta = metasPorCategoria[cat];
        const gasto = gastosMesPorCategoria[cat] || 0;
        const percentual = meta > 0 ? (gasto / meta * 100) : 0;
        
        const item = document.createElement('div');
        item.style.cssText = 'margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed rgba(255,255,255,0.1);';
        item.onclick = () => editarMeta('category');
        item.style.cursor = 'pointer';

        let progressClass = '';
        if(percentual >= 100) progressClass = 'danger';
        else if(percentual >= 80) progressClass = 'warning';
        
        item.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem;">
                <span style="font-weight: 600;">${cat}</span>
                <span style="color: ${percentual > 100 ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">
                    ${formatarMoeda(gasto)} / ${formatarMoeda(meta)} (${percentual.toFixed(0)}%)
                </span>
            </div>
            <div class="progress-bar" style="height: 6px;">
                <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentual, 100)}%;"></div>
            </div>
        `;
        summaryDiv.appendChild(item);
    });
}

function atualizarContadoresFiltros(dataList) {
    document.getElementById("countTodos").innerText = dataList.length;
    document.getElementById("countPendente").innerText = dataList.filter(r => r.status === "Pendente").length;
    document.getElementById("countPago").innerText = dataList.filter(r => r.status === "Pago").length;
    document.getElementById("countRecebido").innerText = dataList.filter(r => r.status === "Recebido").length;
    document.getElementById("countPagar").innerText = dataList.filter(r => r.tipo === "Pagar").length;
    document.getElementById("countReceber").innerText = dataList.filter(r => r.tipo === "Receber").length;
}

// ============================================
// EXIBIÇÃO DE REGISTROS
// ============================================
function mostrarRegistros(lista) {
    const tbody = document.querySelector("#tabelaFinance tbody");
    tbody.innerHTML = "";
    
    atualizarCardsGlobais(registros);
    
    lista.forEach(r => {
        const tr = document.createElement("tr");
        const tipoBadge = r.tipo === "Pagar" ? "badge-pagar" : "badge-receber";
        const statusBadge = r.status === "Pendente" ? "badge-pendente" : (r.status === "Pago" || r.status === "Recebido") ? "badge-pago" : "badge-pendente";
        
        let camposAdicionais = `${r.campo2 || '-'} ${r.campo3 || ''}`;
        if(r.recorrente === 'Sim') camposAdicionais += ' [RECORR.]';
        if(r.parcelaTotal && r.parcelaTotal > 1) camposAdicionais += ` [${r.parcelaAtual}/${r.parcelaTotal}]`;

        let valorDisplay = formatarMoeda(parseFloat(r.valor));
        let acoesHtml = `<button class="btn btn-success btn-sm" onclick="editar(${r.row})">Editar</button><button class="btn btn-danger btn-sm" onclick="excluir(${r.row})">Excluir</button>`;
        
        if(r.valorOriginal && parseFloat(r.valorOriginal) > parseFloat(r.valor)) {
            valorDisplay = `<span style="text-decoration:line-through; opacity: 0.5;">${formatarMoeda(parseFloat(r.valorOriginal))}</span> ${formatarMoeda(parseFloat(r.valor))}`;
        }
        
        if(r.tipo === 'Pagar' && r.status === 'Pendente') {
            acoesHtml = `<button class="btn btn-warning btn-sm" onclick="pagamentoParcial(${r.row})">Parcial</button> ` + acoesHtml;
        }

        tr.innerHTML = `
            <td><span class="star ${r.fav ? 'active' : ''}" onclick="toggleFav(${r.row})">★</span></td>
            <td>${new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
            <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
            <td>${r.descricao}</td>
            <td>${r.categoria || '-'}</td>
            <td><strong>${valorDisplay}</strong></td>
            <td>${r.conta || 'N/A'}</td>
            <td><span class="badge ${statusBadge}" onclick="mudarStatus(${r.row})">${r.status}</span></td>
            <td style="font-size: 0.875rem;">${camposAdicionais}</td>
            <td><div class="actions">${acoesHtml}</div></td>
        `;
        tbody.appendChild(tr);
    });
    
    atualizarGraficos(registros);
}

// ============================================
// GRÁFICOS
// ============================================
function atualizarGraficos(dataList) {
    const fontColor = currentTheme === 'light' ? '#2c3e50' : '#e0e0e0';
    const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
    
    const gastosRealizados = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago");
    const pagamentosPendentes = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pendente");
    const entradasRealizadas = dataList.filter(r => r.tipo === "Receber" && r.status === "Recebido");
    const saidasRealizadas = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago");

    // Gráfico 1: Gastos por Categoria (Pendentes)
    const gastosPendentesPorCategoria = pagamentosPendentes.reduce((acc, r) => {
        acc[r.categoria] = (acc[r.categoria] || 0) + parseFloat(r.valor);
        return acc;
    }, {});
    const categoriasLabels = Object.keys(gastosPendentesPorCategoria);
    const categoriasValores = Object.values(gastosPendentesPorCategoria);
    
    const ctx = document.getElementById('graficoTipo').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categoriasLabels,
            datasets: [{
                data: categoriasValores,
                backgroundColor: ['#ef4444', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'],
                borderColor: currentTheme === 'light' ? '#ffffff' : '#1e1e2e',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {position: 'bottom', labels: {color: fontColor, font: {size: 11, weight: 'bold'}}}
            }
        }
    });

    // Gráfico 2: Fluxo de Caixa
    const dadosFluxo = {};
    const dataInicioFluxo = new Date();
    dataInicioFluxo.setMonth(dataInicioFluxo.getMonth() - 5);
    dataInicioFluxo.setDate(1);

    entradasRealizadas.concat(saidasRealizadas).forEach(r => {
        const dataRegistro = new Date(r.data + 'T12:00:00');
        if(dataRegistro >= dataInicioFluxo) {
            const mesAno = dataRegistro.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            if(!dadosFluxo[mesAno]) dadosFluxo[mesAno] = { entrada: 0, saida: 0 };
            if(r.tipo === "Receber") dadosFluxo[mesAno].entrada += parseFloat(r.valor);
            else if(r.tipo === "Pagar") dadosFluxo[mesAno].saida += parseFloat(r.valor);
        }
    });

    const mesesFluxo = Object.keys(dadosFluxo).sort();
    
    const ctxFluxoCaixa = document.getElementById('graficoFluxoCaixa').getContext('2d');
    if(chartFluxoCaixa) chartFluxoCaixa.destroy();
    chartFluxoCaixa = new Chart(ctxFluxoCaixa, {
        type: 'bar',
        data: {
            labels: mesesFluxo,
            datasets: [
                {label: 'Entradas', data: mesesFluxo.map(m => dadosFluxo[m].entrada), backgroundColor: '#10b981'},
                {label: 'Saídas', data: mesesFluxo.map(m => -dadosFluxo[m].saida), backgroundColor: '#ef4444'}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {legend: {labels: {color: fontColor}}},
            scales: {
                x: {ticks: {color: fontColor}, grid: {color: gridColor}},
                y: {ticks: {color: fontColor, callback: v => formatarMoeda(v)}, grid: {color: gridColor}}
            }
        }
    });

    // Gráfico 3: Comparativo Mensal
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    const mesAnterior = new Date(hoje.setMonth(hoje.getMonth() - 1));
    
    let receitaAtual = 0, despesaAtual = 0, receitaAnterior = 0, despesaAnterior = 0;
    
    dataList.forEach(r => {
        const dataRegistro = new Date(r.data + 'T12:00:00');
        const valor = parseFloat(r.valor);
        
        if(dataRegistro.getMonth() === new Date().getMonth() && dataRegistro.getFullYear() === new Date().getFullYear()) {
            if(r.tipo === "Receber" && r.status === "Recebido") receitaAtual += valor;
            else if(r.tipo === "Pagar" && r.status === "Pago") despesaAtual += valor;
        }
        
        if(dataRegistro.getMonth() === mesAnterior.getMonth() && dataRegistro.getFullYear() === mesAnterior.getFullYear()) {
            if(r.tipo === "Receber" && r.status === "Recebido") receitaAnterior += valor;
            else if(r.tipo === "Pagar" && r.status === "Pago") despesaAnterior += valor;
        }
    });

    const ctxCompMensal = document.getElementById('graficoComparativoMensal').getContext('2d');
    if(chartCompMensal) chartCompMensal.destroy();
    chartCompMensal = new Chart(ctxCompMensal, {
        type: 'bar',
        data: {
            labels: ['Receitas', 'Despesas'],
            datasets: [
                {label: 'Mês Anterior', data: [receitaAnterior, despesaAnterior], backgroundColor: 'rgba(59,130,246,0.6)'},
                {label: 'Mês Atual', data: [receitaAtual, despesaAtual], backgroundColor: 'rgba(16,185,129,0.8)'}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {legend: {labels: {color: fontColor}}},
            scales: {
                x: {ticks: {color: fontColor}, grid: {color: gridColor}},
                y: {beginAtZero: true, ticks: {color: fontColor, callback: v => formatarMoeda(v)}, grid: {color: gridColor}}
            }
        }
    });

    // Gráfico 4: Gastos Diários
    const gastosPorDia = {};
    const hojeDia = new Date();
    for(let i = 6; i >= 0; i--) {
        const data = new Date(hojeDia);
        data.setDate(data.getDate() - i);
        gastosPorDia[data.toISOString().split('T')[0]] = 0;
    }
    
    gastosRealizados.forEach(r => {
        if(gastosPorDia.hasOwnProperty(r.data)) {
            gastosPorDia[r.data] += parseFloat(r.valor);
        }
    });
    
    const diasLabels = Object.keys(gastosPorDia).map(d => new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}));
    const diasValores = Object.values(gastosPorDia);
    
    const ctxDiario = document.getElementById('graficoDiario').getContext('2d');
    if(chartDiario) chartDiario.destroy();
    chartDiario = new Chart(ctxDiario, {
        type: 'line',
        data: {
            labels: diasLabels,
            datasets: [{
                label: 'Gastos Diários',
                data: diasValores,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239,68,68,0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#ef4444',
                pointBorderColor: fontColor,
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {legend: {labels: {color: fontColor}}},
            scales: {
                y: {beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}},
                x: {ticks: {color: fontColor}, grid: {color: gridColor}}
            }
        }
    });
    
    // Gráfico 5: Gastos Mensais por Categoria
    const gastosPorMesECategoria = {};
    const categorias = ["Alimentação", "Moradia/Aluguel", "Transporte", "Lazer", "Saúde", "Educação", "Outros"];
    const mesesLabels = [];

    for(let i = 0; i < 12; i++) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const nomeMes = new Date(d.getFullYear(), d.getMonth(), 1).toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
        mesesLabels.push(nomeMes);
        gastosPorMesECategoria[nomeMes] = {};
        categorias.forEach(cat => gastosPorMesECategoria[nomeMes][cat] = 0);
    }
    mesesLabels.reverse();

    gastosRealizados.forEach(r => {
        if(categorias.includes(r.categoria)) {
            const dataParse = new Date(r.data + 'T12:00:00');
            const nomeMes = dataParse.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
            if(gastosPorMesECategoria.hasOwnProperty(nomeMes)) {
                gastosPorMesECategoria[nomeMes][r.categoria] += parseFloat(r.valor);
            }
        }
    });

    const categoryColors = {
        "Alimentação": "#ef4444", "Moradia/Aluguel": "#3b82f6", "Transporte": "#f59e0b",
        "Lazer": "#10b981", "Saúde": "#8b5cf6", "Educação": "#f59e0b", "Outros": "#6b7280"
    };

    const datasets = categorias.map(cat => ({
        label: cat,
        data: mesesLabels.map(mes => gastosPorMesECategoria[mes][cat]),
        backgroundColor: categoryColors[cat]
    }));
    
    const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
    if(chartMensal) chartMensal.destroy();
    chartMensal = new Chart(ctxMensal, {
        type: 'bar',
        data: {labels: mesesLabels, datasets: datasets},
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {legend: {labels: {color: fontColor}}},
            scales: {
                x: {stacked: true, ticks: {color: fontColor}, grid: {color: gridColor}},
                y: {stacked: true, beginAtZero: true, ticks: {color: fontColor, callback: v => formatarMoeda(v)}, grid: {color: gridColor}}
            }
        }
    });
}

// ============================================
// CALENDÁRIO
// ============================================
function renderizarCalendario(dataList) {
    const calDiv = document.getElementById('financialCalendar');
    calDiv.innerHTML = '<div class="calendar-header">Dom</div><div class="calendar-header">Seg</div><div class="calendar-header">Ter</div><div class="calendar-header">Qua</div><div class="calendar-header">Qui</div><div class="calendar-header">Sex</div><div class="calendar-header">Sáb</div>';
    
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth();
    
    document.getElementById('calendarHeader').innerText = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    
    const primeiroDia = new Date(ano, mes, 1);
    const ultimoDia = new Date(ano, mes + 1, 0);
    const diasNoMes = ultimoDia.getDate();
    const diaDaSemanaInicio = primeiroDia.getDay();

    for(let i = 0; i < diaDaSemanaInicio; i++) {
        calDiv.innerHTML += '<div style="aspect-ratio: 1;"></div>';
    }

    const eventosDoMes = dataList.filter(r => {
        const dataReg = new Date(r.data + 'T12:00:00');
        return dataReg.getFullYear() === ano && dataReg.getMonth() === mes;
    }).reduce((acc, r) => {
        const dia = new Date(r.data + 'T12:00:00').getDate();
        if(!acc[dia]) acc[dia] = { pagar: 0, receber: 0, itens: [] };
        if(r.status === 'Pendente') {
            if(r.tipo === 'Pagar') acc[dia].pagar += parseFloat(r.valor);
            else if(r.tipo === 'Receber') acc[dia].receber += parseFloat(r.valor);
            acc[dia].itens.push(r);
        }
        return acc;
    }, {});

    for(let dia = 1; dia <= diasNoMes; dia++) {
        const diaDiv = document.createElement('div');
        diaDiv.className = 'calendar-day';
        if(eventosDoMes[dia] && (eventosDoMes[dia].pagar > 0 || eventosDoMes[dia].receber > 0)) {
            diaDiv.classList.add('has-events');
            diaDiv.onclick = () => {
                const itens = eventosDoMes[dia].itens.map(i => `${i.tipo}: ${i.descricao} (${formatarMoeda(i.valor)})`).join('\n');
                alert(`Lançamentos para ${dia}/${mes+1}:\n\n${itens}`);
            };
        }
        
        let diaHtml = `<div class="day-number">${dia}</div>`;
        if(eventosDoMes[dia]) {
            if(eventosDoMes[dia].pagar > 0) diaHtml += `<div class="day-amount day-pagar">-${formatarMoeda(eventosDoMes[dia].pagar)}</div>`;
            if(eventosDoMes[dia].receber > 0) diaHtml += `<div class="day-amount day-receber">+${formatarMoeda(eventosDoMes[dia].receber)}</div>`;
        }
        
        diaDiv.innerHTML = diaHtml;
        calDiv.appendChild(diaDiv);
    }
}

// ============================================
// FILTROS
// ============================================
function aplicarFiltros() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const categoriaFiltro = document.getElementById("filtroCategoria").value;
    const periodoSelecionado = document.getElementById("filtroPeriodo").value;
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const summaryDiv = document.getElementById("periodSummary");
    
    let filtrados = registros;
    let totalPagarPeriodo = 0, totalReceberPeriodo = 0;
    let dataFiltroAtivo = false;
    let dataInicioFiltro, dataFimFiltro;

    if(periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999);

        if(periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if(periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio;
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1);
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59');
        } else if(periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if(!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            }
        } else {
            const dias = parseInt(periodoSelecionado);
            if(!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            }
        }
        
        if(dataInicioFiltro && dataFimFiltro) dataFiltroAtivo = true;
        dataInicioStr = '';
        dataFimStr = '';
    }
    
    if(dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59');
        dataFiltroAtivo = true;
    }

    if(dataFiltroAtivo) {
        filtrados = filtrados.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00');
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }

    if(filtroStatusAtual !== 'todos') {
        if(filtroStatusAtual === 'tipo-pagar') filtrados = filtrados.filter(r => r.tipo === 'Pagar');
        else if(filtroStatusAtual === 'tipo-receber') filtrados = filtrados.filter(r => r.tipo === 'Receber');
        else filtrados = filtrados.filter(r => r.status === filtroStatusAtual);
    }

    if(mostraApenasFav) filtrados = filtrados.filter(r => r.fav);
    if(categoriaFiltro !== 'all') filtrados = filtrados.filter(r => r.categoria === categoriaFiltro);

    if(termo) {
        filtrados = filtrados.filter(r =>
            r.descricao.toLowerCase().includes(termo) ||
            r.tipo.toLowerCase().includes(termo) ||
            r.categoria.toLowerCase().includes(termo) ||
            r.conta.toLowerCase().includes(termo) ||
            r.data.includes(termo)
        );
    }
    
    totalPagarPeriodo = filtrados.filter(r => r.tipo === "Pagar").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    totalReceberPeriodo = filtrados.filter(r => r.tipo === "Receber").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    
    if(dataFiltroAtivo || mostraApenasFav || termo || filtroStatusAtual !== 'todos' || categoriaFiltro !== 'all') {
        document.getElementById("summaryPagar").innerText = formatarMoeda(totalPagarPeriodo);
        document.getElementById("summaryReceber").innerText = formatarMoeda(totalReceberPeriodo);
        document.getElementById("summarySaldo").innerText = formatarMoeda(totalReceberPeriodo - totalPagarPeriodo);
        summaryDiv.classList.remove('hidden');
    } else {
        summaryDiv.classList.add('hidden');
    }

    mostrarRegistros(filtrados);
}

function filtrarPorStatus(tipo) {
    filtroStatusAtual = tipo;
    document.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
    
    if(tipo === 'todos') document.querySelector('.filter-tab').classList.add('active');
    else document.querySelectorAll('.filter-tab').forEach(btn => {
        if(btn.textContent.includes(tipo) || 
           (tipo === 'tipo-pagar' && btn.textContent.includes('A Pagar')) ||
           (tipo === 'tipo-receber' && btn.textContent.includes('A Receber'))) {
            btn.classList.add('active');
        }
    });
    
    aplicarFiltros();
}

// ============================================
// FORMULÁRIO E AÇÕES
// ============================================
function toggleParcelaRecorrente() {
    const tipo = document.getElementById("tipo").value;
    const parcelamentoGroup = document.getElementById("parcelamentoGroup");
    const recorrenciaGroup = document.getElementById("recorrenciaGroup");

    if(tipo === 'Pagar') {
        parcelamentoGroup.classList.remove('hidden');
        recorrenciaGroup.classList.remove('hidden');
    } else {
        parcelamentoGroup.classList.add('hidden');
        document.getElementById("parcelas").value = 1;
        recorrenciaGroup.classList.remove('hidden');
    }

    if(parseInt(document.getElementById("parcelas").value) > 1) {
        document.getElementById("recorrencia").value = 'Nao';
        document.getElementById("recorrencia").disabled = true;
    } else {
        document.getElementById("recorrencia").disabled = false;
    }
}

function aplicarRegrasAutomacao(descricao, categoria) {
    if(categoria && categoria !== 'Selecione a Categoria') return categoria;
    const termoNormalizado = descricao.toLowerCase().trim();
    for(const regra of regrasAutomacao) {
        if(termoNormalizado.includes(regra.termo)) return regra.categoria;
    }
    return categoria;
}

document.getElementById("financeForm").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const tipo = document.getElementById("tipo").value;
    const descricao = document.getElementById("descricao").value;
    const valor = parseFloat(document.getElementById("valor").value);
    const status = document.getElementById("status").value;
    let categoria = document.getElementById("categoria").value;
    const conta = document.getElementById("conta").value;
    const campo2 = document.getElementById("campo2").value;
    const campo3 = document.getElementById("campo3").value;
    const recorrente = document.getElementById("recorrencia").value;
    const parcelas = tipo === 'Pagar' ? parseInt(document.getElementById("parcelas").value) : 1;
    
    categoria = aplicarRegrasAutomacao(descricao, categoria);
    
    if(!categoria || categoria === 'Selecione a Categoria') {
        alert("Preencha a Categoria (obrigatória).");
        return;
    }
    
    const row = document.getElementById("row").value;
    const sheetRowId = document.getElementById("sheetRowId").value;
    
    if(row) {
        const idx = registros.findIndex(r => r.id == sheetRowId);
        if(idx !== -1) {
            const registroExistente = registros[idx];
            const dadosRegistro = {
                data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status,
                categoria, campo2, campo3, conta, recorrente,
                parcelaAtual: registroExistente.parcelaAtual, parcelaTotal: registroExistente.parcelaTotal,
                valorOriginal: registroExistente.valorOriginal || (registroExistente.valor !== valor ? registroExistente.valor : null)
            };
            registros[idx] = {...registroExistente, ...dadosRegistro, row: parseInt(row)};
            enviarParaPlanilha({...registros[idx], action: 'update', campo1: categoria});
        }
        document.getElementById("row").value = "";
        document.getElementById("sheetRowId").value = "";
    } else {
        if(tipo === 'Pagar' && parcelas > 1) {
            for(let i = 1; i <= parcelas; i++) {
                const dataParcela = new Date(document.getElementById("data").value + 'T12:00:00');
                dataParcela.setMonth(dataParcela.getMonth() + (i - 1));
                const novoRegistro = {
                    data: corrigirData(dataParcela.toISOString().split('T')[0]),
                    tipo, descricao: `${descricao} (${i}/${parcelas})`,
                    valor: valor, status, categoria, campo2, campo3, conta,
                    recorrente: 'Nao',
                    parcelaAtual: i,
                    parcelaTotal: parcelas,
                    row: registros.length + i,
                    fav: false
                };
                registros.push(novoRegistro);
                enviarParaPlanilha({...novoRegistro, action: 'add', campo1: categoria});
            }
        } else if(recorrente === 'Sim') {
            const novoRegistro = {
                data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status,
                categoria, campo2, campo3, conta, recorrente,
                parcelaAtual: 1, parcelaTotal: 1,
                row: registros.length + 1, fav: false
            };
            registros.push(novoRegistro);
            enviarParaPlanilha({...novoRegistro, action: 'add', campo1: categoria});
            alert(`✅ Recorrente salvo! A rotina criará os próximos lançamentos.`);
        } else {
            const novoRegistro = {
                data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status,
                categoria, campo2, campo3, conta, recorrente: 'Nao',
                parcelaAtual: 1, parcelaTotal: 1,
                row: registros.length + 1, fav: false
            };
            registros.push(novoRegistro);
            enviarParaPlanilha({...novoRegistro, action: 'add', campo1: categoria});
        }
    }
    
    this.reset();
    document.getElementById("data").valueAsDate = new Date();
    document.getElementById("parcelas").value = 1;
    document.getElementById("recorrencia").value = 'Nao';
    toggleParcelaRecorrente();
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    aplicarFiltros();
    document.getElementById("descricao").focus();
});

function editar(row) {
    const r = registros.find(r => r.row === row);
    if(r) {
        document.getElementById("row").value = r.row;
        document.getElementById("sheetRowId").value = r.id;
        document.getElementById("data").value = r.data;
        document.getElementById("tipo").value = r.tipo;
        document.getElementById("valor").value = r.valor;
        document.getElementById("status").value = r.status;
        document.getElementById("descricao").value = r.descricao.replace(/\s\(\d+\/\d+\)$/, '');
        document.getElementById("categoria").value = r.categoria || '';
        document.getElementById("conta").value = r.conta || 'Conta Corrente';
        document.getElementById("recorrencia").value = r.recorrente || 'Nao';
        document.getElementById("parcelas").value = r.parcelaTotal || 1;
        toggleParcelaRecorrente();
        document.getElementById("campo2").value = r.campo2 || '';
        document.getElementById("campo3").value = r.campo3 || '';
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
}

function excluir(row) {
    if(confirm("Deseja excluir este registro?")) {
        const r = registros.find(r => r.row === row);
        const idx = registros.findIndex(r => r.row === row);
        enviarParaPlanilha({...r, action: 'delete'});
        registros.splice(idx, 1);
        mostraApenasFav = false;
        document.getElementById("btnFiltrarFav").classList.remove("active");
        aplicarFiltros();
    }
}

function toggleFav(row) {
    const idx = registros.findIndex(r => r.row === row);
    registros[idx].fav = !registros[idx].fav;
    enviarParaPlanilha({...registros[idx], action: 'update'});
    aplicarFiltros();
}

function mudarStatus(row) {
    const registro = registros.find(r => r.row === row);
    if(!registro) return;
    
    let novoStatus = registro.status;
    if(registro.status === "Pendente") {
        novoStatus = registro.tipo === "Pagar" ? "Pago" : "Recebido";
        if(registro.valorOriginal && parseFloat(registro.valorOriginal) > parseFloat(registro.valor)) {
            if(!confirm(`O saldo devedor é ${formatarMoeda(parseFloat(registro.valor))}. Deseja marcar como '${novoStatus}' (assumindo que o restante foi pago)?`)) {
                return;
            }
        }
        if(registro.valorOriginal) {
            registro.valor = registro.valorOriginal;
        }
        registro.valorOriginal = null;
    } else {
        novoStatus = "Pendente";
        registro.valorOriginal = null;
    }
    
    registro.status = novoStatus;
    enviarParaPlanilha({...registro, action: 'update', campo1: registro.categoria});
    aplicarFiltros();
}

function pagamentoParcial(row) {
    const registro = registros.find(r => r.row === row);
    if(!registro || registro.tipo !== 'Pagar' || registro.status !== 'Pendente') return;

    const valorOriginal = registro.valorOriginal || parseFloat(registro.valor);
    const valorAtual = parseFloat(registro.valor);

    const valorPagoStr = prompt(`Pagamento Parcial para:\n${registro.descricao} - ${formatarMoeda(valorAtual)}\n\nDigite o valor a pagar (máx: ${formatarMoeda(valorAtual)}):`);
    
    if(valorPagoStr === null) return;
    
    const valorPago = parseFloat(valorPagoStr.replace(',', '.'));
    
    if(isNaN(valorPago) || valorPago <= 0) {
        alert("❌ Valor inválido.");
        return;
    }

    if(valorPago > valorAtual) {
        alert("❌ O valor pago não pode ser maior que o saldo devedor.");
        return;
    }
    
    const novoValorRestante = valorAtual - valorPago;
    
    if(novoValorRestante <= 0.01) {
        registro.valor = 0;
        registro.status = 'Pago';
        registro.valorOriginal = valorOriginal;
        alert(`✅ ${formatarMoeda(valorPago)} pago. Registro marcado como 'Pago'.`);
    } else {
        registro.valor = novoValorRestante.toFixed(2);
        registro.valorOriginal = valorOriginal;
        alert(`✅ ${formatarMoeda(valorPago)} pago. Saldo restante: ${formatarMoeda(novoValorRestante)}.`);
    }

    enviarParaPlanilha({...registro, action: 'update', campo1: registro.categoria});
    aplicarFiltros();
}

function editarMeta(type) {
    if(type === 'global') {
        const tipoAtual = metaTipo === 'diario' ? 'Diário' : 'Mensal';
        const novoTipo = prompt(`Tipo de Meta Atual: ${tipoAtual}\n\nDigite:\n1 - Para Meta Diária\n2 - Para Meta Mensal`, metaTipo === 'diario' ? '1' : '2');
        
        if(novoTipo === '1') {
            metaTipo = 'diario';
        } else if(novoTipo === '2') {
            metaTipo = 'mensal';
        } else if(novoTipo !== null) {
            alert('Opção inválida! Use 1 para Diário ou 2 para Mensal.');
            return;
        } else {
            return;
        }
        
        const novoValor = prompt(`Meta de Gastos ${metaTipo === 'diario' ? 'Diária' : 'Mensal'}:\n\nValor Atual: R$ ${metaValor.toFixed(2)}\n\nDigite o novo valor (ex: 5000):`, metaValor);
        
        if(novoValor !== null) {
            const valorParseado = parseFloat(novoValor.replace(',', '.'));
            if(!isNaN(valorParseado) && valorParseado > 0) {
                metaValor = valorParseado;
                localStorage.setItem('metaTipo', metaTipo);
                localStorage.setItem('metaValor', metaValor);
                
                const hoje = new Date();
                const hojeStr = hoje.toISOString().split('T')[0];
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                let gastoHoje = 0, gastoMes = 0;
                registros.forEach(r => {
                    const dataRegistro = new Date(r.data + 'T12:00:00');
                    const valor = parseFloat(r.valor);
                    if(r.data === hojeStr && r.tipo === "Pagar" && r.status === "Pago") gastoHoje += valor;
                    if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo === "Pagar" && r.status === "Pago") gastoMes += valor;
                });
                
                atualizarCardMeta(gastoHoje, gastoMes);
                alert(`✅ Meta ${metaTipo === 'diario' ? 'Diária' : 'Mensal'} atualizada para ${formatarMoeda(metaValor)}`);
            } else {
                alert('❌ Valor inválido! Digite um número positivo.');
            }
        }
    } else if(type === 'objetivo') {
        const novoObjetivo = prompt(`Objetivo de Economia/Investimento:\n\nValor Atual: R$ ${objetivoEconomia.toFixed(2)}\n\nDigite o valor total do objetivo (ex: 10000):`, objetivoEconomia);
        
        if(novoObjetivo !== null) {
            const valorParseado = parseFloat(novoObjetivo.replace(',', '.'));
            if(!isNaN(valorParseado) && valorParseado > 0) {
                objetivoEconomia = valorParseado;
                localStorage.setItem('objetivoEconomia', objetivoEconomia);
            } else {
                alert('❌ Valor do Objetivo inválido! Digite um número positivo.');
                return;
            }
        } else {
            return;
        }
        
        const novosMeses = prompt(`Prazo (em meses) para o Objetivo:\n\nPrazo Atual: ${objetivoMeses} meses\n\nDigite o novo prazo (ex: 12):`, objetivoMeses);
        
        if(novosMeses !== null) {
            const mesesParseado = parseInt(novosMeses);
            if(!isNaN(mesesParseado) && mesesParseado > 0) {
                objetivoMeses = mesesParseado;
                localStorage.setItem('objetivoMeses', objetivoMeses);
            } else {
                alert('❌ Prazo inválido! Digite um número inteiro positivo.');
                return;
            }
        } else {
            return;
        }

        atualizarCardObjetivo();
        alert(`✅ Objetivo atualizado: ${formatarMoeda(objetivoEconomia)} em ${objetivoMeses} meses.`);
    } else {
        const cat = prompt(`Digite a categoria para definir/editar a meta (ex: Alimentação):`);
        if(!cat) return;
        
        const valorAtual = metasPorCategoria[cat] || 0;
        const novoValorStr = prompt(`Meta de Gastos MENSAL para ${cat}:\n\nValor Atual: R$ ${valorAtual.toFixed(2)}\n\nDigite o novo valor (0 para remover):`, valorAtual);
        
        if(novoValorStr !== null) {
            const novoValor = parseFloat(novoValorStr.replace(',', '.'));
            if(!isNaN(novoValor) && novoValor >= 0) {
                if(novoValor === 0) {
                    delete metasPorCategoria[cat];
                    alert(`✅ Meta para ${cat} removida.`);
                } else {
                    metasPorCategoria[cat] = novoValor;
                    alert(`✅ Meta para ${cat} definida em ${formatarMoeda(novoValor)}.`);
                }
                localStorage.setItem('metasPorCategoria', JSON.stringify(metasPorCategoria));
                atualizarCardsGlobais(registros);
            } else {
                alert('❌ Valor inválido! Digite um número positivo ou zero.');
            }
        }
    }
}

function toggleCompactMode(button) {
    const table = document.getElementById('tabelaFinance');
    if(table.classList.contains('table-compact')) {
        table.classList.remove('table-compact');
        button.innerText = '↔️ Modo Compacto';
    } else {
        table.classList.add('table-compact');
        button.innerText = '↕️ Modo Expandido';
    }
}

function exportarExcel() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const periodoSelecionado = document.getElementById("filtroPeriodo").value;
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const categoriaFiltro = document.getElementById("filtroCategoria").value;

    let listaExportar = registros;
    let dataFiltroAtivo = false;
    let dataInicioFiltro, dataFimFiltro;

    if(periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999);

        if(periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if(periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio;
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1);
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59');
        } else if(periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if(!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            }
        } else {
            const dias = parseInt(periodoSelecionado);
            if(!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            }
        }
        
        if(dataInicioFiltro && dataFimFiltro) dataFiltroAtivo = true;
    }
    
    if(dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59');
        dataFiltroAtivo = true;
    }
    
    if(dataFiltroAtivo) {
        listaExportar = listaExportar.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00');
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }

    if(filtroStatusAtual !== 'todos') {
        if(filtroStatusAtual === 'tipo-pagar') listaExportar = listaExportar.filter(r => r.tipo === 'Pagar');
        else if(filtroStatusAtual === 'tipo-receber') listaExportar = listaExportar.filter(r => r.tipo === 'Receber');
        else listaExportar = listaExportar.filter(r => r.status === filtroStatusAtual);
    }

    if(mostraApenasFav) listaExportar = listaExportar.filter(r => r.fav);
    if(categoriaFiltro !== 'all') listaExportar = listaExportar.filter(r => r.categoria === categoriaFiltro);

    if(termo) {
        listaExportar = listaExportar.filter(r =>
            r.descricao.toLowerCase().includes(termo) ||
            r.tipo.toLowerCase().includes(termo) ||
            r.categoria.toLowerCase().includes(termo) ||
            r.conta.toLowerCase().includes(termo) ||
            r.data.includes(termo)
        );
    }
    
    const ws_data = listaExportar.map(r => [
        r.fav ? "★" : "",
        new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR'),
        r.tipo,
        r.descricao,
        r.categoria || '-',
        r.valor,
        r.valorOriginal ? r.valorOriginal : '',
        r.status,
        r.conta || 'N/A',
        r.recorrente,
        r.parcelaTotal > 1 ? `${r.parcelaAtual}/${r.parcelaTotal}` : '',
        r.campo2 || '',
        r.campo3 || ''
    ]);

    ws_data.unshift(["Fav", "Data", "Tipo", "Descrição", "Categoria", "Valor", "Valor Original", "Status", "Conta", "Recorrente", "Parcelas", "Campo2", "Campo3"]);
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Financeiro");
    XLSX.writeFile(wb, "Controle_Financeiro_Moderno.xlsx");
}

// ============================================
// FAB E ATALHOS
// ============================================
function toggleQuickMenu() {
    document.getElementById('quickMenu').classList.toggle('visible');
}

function focarFormulario(tipo) {
    document.getElementById("tipo").value = tipo;
    toggleParcelaRecorrente();
    document.getElementById("descricao").focus();
    toggleQuickMenu();
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// ============================================
// EVENT LISTENERS
// ============================================
document.getElementById("filtroPeriodo").addEventListener("change", function() {
    const customDaysInput = document.getElementById("customDaysInput");
    if(this.value === 'customDays') {
        customDaysInput.classList.remove('hidden');
    } else {
        customDaysInput.classList.add('hidden');
        document.getElementById("diasCustomizados").value = '';
    }
    aplicarFiltros();
});

document.getElementById("diasCustomizados").addEventListener("input", aplicarFiltros);
document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("btnFiltrarData").addEventListener("click", aplicarFiltros);

document.getElementById("btnFiltrarFav").addEventListener("click", function() {
    mostraApenasFav = !mostraApenasFav;
    this.classList.toggle("active");
    aplicarFiltros();
});

document.getElementById("descricao").addEventListener("input", function() {
    const categoriaAtual = document.getElementById("categoria").value;
    if(!categoriaAtual || categoriaAtual === 'Selecione a Categoria') {
        const categoriaSugerida = aplicarRegrasAutomacao(this.value, null);
        if(categoriaSugerida) {
            document.getElementById("categoria").value = categoriaSugerida;
        }
    }
});

document.addEventListener('keydown', (e) => {
    if(usuarioAutenticado) {
        if(e.key === '+' || e.key.toLowerCase() === 'n') {
            e.preventDefault();
            document.getElementById("descricao").focus();
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    }
});

// ============================================
// INICIALIZAÇÃO
// ============================================
document.getElementById("data").valueAsDate = new Date();
verificarAutenticacao();
applyTheme();
toggleParcelaRecorrente();
atualizarCardObjetivo();

setInterval(() => {
    if(usuarioAutenticado) {
        carregarRegistros();
        console.log("↻ Sincronizando...");
    }
}, 10000);
</script>

</body>
</html>
   
