<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Financeiro - Versão Avançada</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* VARIÁVEIS DE COR E TEMA */
:root {
    --bg-dark: linear-gradient(135deg,#0f0c29 0%,#302b63 50%,#24243e 100%);
    --bg-light: linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
    --card-bg-dark: linear-gradient(135deg,rgba(42,42,62,0.95) 0%,rgba(31,31,46,0.95) 100%);
    --card-bg-light: linear-gradient(135deg,#ffffff 0%,#f8f9fa 100%);
    --text-color-dark: #e0e0e0;
    --text-color-light: #333333;
    --header-color-dark: #fff;
    --header-color-light: #4a90e2;
    --input-bg-dark: rgba(255,255,255,0.08);
    --input-bg-light: #ffffff;
    --input-border-dark: rgba(255,255,255,0.25);
    --input-border-light: #dddddd;
    --table-header-bg-dark: rgba(255,255,255,0.08);
    --table-header-bg-light: #f5f5f5;
    --table-row-hover-dark: rgba(255,255,255,0.08);
    --table-row-hover-light: #f0f0f0;
    --primary-color: #667eea;
    --pagar-color: #f093fb;
    --receber-color: #4facfe;
    --vencido-color: #fa709a;
    --meta-color: #a18cd1;
    --warning-color: #fbc531;
    --sobra-color: #00d2ff;
    --falta-color: #ee5a6f;
    --fab-color: #667eea;
    --qr-color: #764ba2;
}
/* TEMA CLARO */
html[data-theme="light"] {
    --bg-dark: var(--bg-light);
    --card-bg-dark: var(--card-bg-light);
    --text-color-dark: var(--text-color-light);
    --header-color-dark: var(--header-color-light);
    --input-bg-dark: var(--input-bg-light);
    --input-border-dark: var(--input-border-light);
    --table-header-bg-dark: var(--table-header-bg-light);
    --table-row-hover-dark: var(--table-row-hover-light);
    --sync-dot-dark: var(--receber-color);
}
/* ESTILOS BASEADOS EM VARIÁVEIS */
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:var(--bg-dark);
  padding:20px; 
  color:var(--text-color-dark);
  min-height:100vh;
  transition: background 0.5s, color 0.5s;
}
.container { max-width:1400px; margin:0 auto; }
header { text-align:center; margin-bottom:40px; }
header h1 { 
  font-size:2.5em; 
  color:var(--header-color-dark); 
  font-weight:700;
  letter-spacing:-1px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:15px;
}
/* Estilos para o botão de tema */
.theme-toggle-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-color);
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
/* Estilos para o FAB (Floating Action Button) - Sugestão 25 */
.fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 900;
}
.fab-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--fab-color);
    color: white;
    font-size: 2em;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, background 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
.fab-btn:hover {
    background: #455be9; /* Um pouco mais escuro que o fab-color */
    transform: scale(1.05);
}
.quick-menu {
    position: absolute;
    bottom: 70px;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateY(10px);
}
.quick-menu.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}
.quick-menu button {
    width: 150px;
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 0.9em;
    font-weight: 600;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.quick-menu .btn-pagar {
    background: var(--pagar-color);
    color: white;
}
.quick-menu .btn-receber {
    background: var(--receber-color);
    color: white;
}
.loading {
    display: none;
    text-align: center;
    padding: 15px;
    color: var(--primary-color);
    font-weight: 600;
}
.loading.show {
    display: block;
}
.sync-status {
  background:rgba(79,175,254,0.2);
  border:1px solid rgba(79,175,254,0.5);
  color:var(--receber-color);
  padding:10px 15px;
  border-radius:10px;
  font-size:0.9em;
  margin-bottom:20px;
  display:flex;
  align-items:center;
  gap:10px;
  width:fit-content;
  margin-left:auto;
  margin-right:auto;
}
.sync-status.offline {
  background:rgba(240,147,251,0.2);
  border-color:rgba(240,147,251,0.5);
  color:var(--pagar-color);
}
.sync-status .dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:var(--receber-color);
  animation:pulse 2s infinite;
}
.sync-status.offline .dot {
  background:var(--pagar-color);
  animation:none;
}
@keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }
.cards-summary { 
  display:grid; 
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px; 
  margin-bottom:30px; 
}
.card { 
  background:var(--card-bg-dark);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition:transform 0.3s ease,box-shadow 0.3s ease, background 0.5s;
  backdrop-filter:blur(10px);
}
html[data-theme="light"] .card {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border: 1px solid #eeeeee;
}
.card:hover { 
  transform:translateY(-5px); 
  box-shadow:0 15px 50px rgba(0,0,0,0.4);
}
.card-label { 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:10px; 
  text-transform:uppercase; 
  letter-spacing:1px;
  font-weight:600;
}
.card-value { 
  font-size:1.8em;
  font-weight:700;
  letter-spacing:-1px;
}
.card-pagar .card-value { color:var(--pagar-color); }
.card-receber .card-value { color:var(--receber-color); }
.card-saldo .card-value { color:var(--primary-color); }
.card-vencido .card-value { color:var(--vencido-color); }
.card-meta .card-value { color:var(--meta-color); }
/* Novo estilo para Sobra/Falta */
.card-sobra .card-value { color:var(--sobra-color); }
.card-falta .card-value { color:var(--falta-color); }
.card-meta { position: relative; cursor: pointer; }
.card-meta:hover { border-color: var(--meta-color); }
.card-meta .edit-hint {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 0.8em;
    color: var(--meta-color);
    opacity: 0.7;
}
.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    margin-top: 10px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--receber-color), var(--primary-color));
    border-radius: 10px;
    transition: width 0.3s ease;
}
.progress-fill.warning {
    background: linear-gradient(90deg, var(--warning-color), var(--pagar-color));
}
.progress-fill.danger {
    background: linear-gradient(90deg, var(--pagar-color), var(--vencido-color));
}
.content { 
  display:grid; 
  grid-template-columns:1fr 1fr; 
  gap:25px; 
  margin-bottom:30px; 
}
.full-width-grid {
    grid-template-columns: 1fr;
}
.triple-grid {
    grid-template-columns: 1fr 1fr 1fr;
}
.form-section, .chart-section, .table-section { 
  background:var(--card-bg-dark);
  border-radius:16px; 
  padding:25px; 
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.1);
  transition: background 0.5s;
}
html[data-theme="light"] .form-section, 
html[data-theme="light"] .chart-section, 
html[data-theme="light"] .table-section {
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    border: 1px solid #eeeeee;
}
.form-section h2, .chart-section h2, .table-section h2 { 
  font-size:1.4em; 
  margin-bottom:20px;
  color:var(--header-color-dark);
  font-weight:700;
  transition: color 0.5s;
}
.form-group { margin-bottom:15px; }
label { 
  display:block; 
  font-size:0.9em; 
  color:#b0b0b0; 
  margin-bottom:8px; 
  text-transform:uppercase; 
  font-weight:600;
  letter-spacing:0.5px;
}
input, select { 
  width:100%; 
  padding:12px 15px; 
  border:1px solid var(--input-border-dark); 
  border-radius:10px; 
  background:var(--input-bg-dark);
  color:var(--text-color-dark);
  font-size:1em;
  transition:all 0.3s ease;
}
html[data-theme="light"] input, 
html[data-theme="light"] select {
    color: var(--text-color-light);
}
input:focus, select:focus { 
  outline:none;
  border-color:var(--primary-color);
  background:rgba(102,126,234,0.1);
  box-shadow:0 0 20px rgba(102,126,234,0.3);
}
button { 
  padding:12px 24px; 
  border:none; 
  border-radius:10px; 
  cursor:pointer; 
  font-weight:600;
  font-size:1em;
  transition:all 0.3s ease;
}
.btn-primary { 
  background:linear-gradient(135deg,var(--primary-color) 0%,#455be9 100%);
  color:white; 
  width:100%; 
}
.btn-primary:hover { 
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(102,126,234,0.4);
}
.btn-danger { 
  background:linear-gradient(135deg,var(--vencido-color) 0%,#d34c6e 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
.btn-edit { 
  background:linear-gradient(135deg,var(--receber-color) 0%,#3d8fd8 100%);
  color:white; 
  font-size:0.9em;
  padding:8px 16px;
}
/* Novo botão para Pagamento Parcial */
.btn-partial {
    background: linear-gradient(135deg, var(--warning-color) 0%, #d89f1f 100%);
    color: white; 
    font-size: 0.85em;
    padding: 8px 10px;
}
.btn-filter {
  background:linear-gradient(135deg,#fbc531 0%,#e19812 100%);
  color:white;
  padding:10px 20px;
  margin-bottom:0; 
  font-size:0.95em;
  width: auto;
}
.btn-filter.active {
  background:linear-gradient(135deg,var(--pagar-color) 0%,#a176e0 100%);
}
.search-bar { margin-bottom:15px; }
.search-bar input { width:100%; }
table { width:100%; border-collapse:collapse; }
th { 
  padding:15px 10px; 
  text-align:left; 
  background:var(--table-header-bg-dark);
  border-bottom:2px solid rgba(255,255,255,0.1);
  font-weight:700;
  color:var(--header-color-dark);
  font-size:0.95em;
  transition: background 0.5s, color 0.5s;
}
td { 
  padding:15px 10px; 
  border-bottom:1px solid rgba(255,255,255,0.05); 
}
html[data-theme="light"] td {
    border-bottom: 1px solid #eeeeee;
}
tr:hover { background:var(--table-row-hover-dark); }
.badge { 
  padding:6px 12px; 
  border-radius:20px; 
  font-size:0.8em; 
  font-weight:700; 
  text-transform:uppercase;
  letter-spacing:0.5px;
  display:inline-block;
}
.badge-pagar { 
  background:rgba(240,147,251,0.2); 
  color:var(--pagar-color); 
  border:1px solid rgba(240,147,251,0.5);
}
.badge-receber { 
  background:rgba(79,175,254,0.2); 
  color:var(--receber-color); 
  border:1px solid rgba(79,175,254,0.5);
}
.badge-pendente { 
  background:rgba(251,197,49,0.2); 
  color:var(--warning-color); 
  border:1px solid rgba(251,197,49,0.5);
}
.badge-pago { 
  background:rgba(79,175,254,0.2); 
  color:var(--receber-color); 
  border:1px solid rgba(79,175,254,0.5);
}
.status-filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--input-bg-dark);
    border-radius: 10px;
    border: 1px solid var(--input-border-dark);
}
.status-filter-btn {
    padding: 8px 16px;
    border: 2px solid transparent;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    color: var(--text-color-dark);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}
.status-filter-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.status-filter-btn.active {
    border-color: var(--primary-color);
    background: rgba(102,126,234,0.2);
    color: var(--primary-color);
}
.status-filter-btn.filter-pendente.active {
    border-color: var(--warning-color);
    background: rgba(251,197,49,0.2);
    color: var(--warning-color);
}
.status-filter-btn.filter-pago.active {
    border-color: var(--receber-color);
    background: rgba(79,175,254,0.2);
    color: var(--receber-color);
}
.status-filter-btn.filter-recebido.active {
    border-color: var(--receber-color);
    background: rgba(79,175,254,0.2);
    color: var(--receber-color);
}
.status-filter-btn.filter-pagar.active {
    border-color: var(--pagar-color);
    background: rgba(240,147,251,0.2);
    color: var(--pagar-color);
}
.status-filter-btn.filter-receber.active {
    border-color: var(--receber-color);
    background: rgba(79,175,254,0.2);
    color: var(--receber-color);
}
.filter-count {
    background: rgba(255,255,255,0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 700;
}
.actions { 
  display:flex; 
  gap:8px;
  flex-wrap: wrap; /* Permite quebrar em telas pequenas */
}
.filter-controls {
    display:flex; 
    gap:10px; 
    margin-bottom:15px; 
    flex-wrap:wrap; 
    align-items:flex-end;
}
.filter-item {
    min-width:150px;
    flex: 1;
}
.filter-item-large {
    flex: 2;
    min-width: 250px;
}
.filter-summary {
    background: rgba(102,126,234,0.1);
    border: 1px solid var(--primary-color);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    font-weight: 600;
    display: flex;
    justify-content: space-around;
    align-items: center;
    flex-wrap: wrap;
    display: none;
}
.filter-summary span {
    margin: 5px 10px;
}
.summary-value-pagar { color: var(--pagar-color); font-weight: 700; }
.summary-value-receber { color: var(--receber-color); font-weight: 700; }
.summary-value-saldo { color: var(--primary-color); font-weight: 700; }
.star-empty, .star {
    font-size: 1.2em;
    cursor: pointer;
    transition: color 0.2s;
}
.star-empty {
    color: #b0b0b0;
}
.star {
    color: #fbc531;
}
/* Novo: Estilos para Metas por Categoria */
.category-progress-container {
    margin-top: 20px;
    padding: 15px;
    background: var(--input-bg-dark);
    border-radius: 10px;
    border: 1px solid var(--input-border-dark);
    max-height: 250px;
    overflow-y: auto;
}
.category-progress-item {
    margin-bottom: 10px;
    padding: 8px 0;
    border-bottom: 1px dashed rgba(255,255,255,0.05);
}
.category-progress-item:last-child {
    border-bottom: none;
}
.category-progress-item .label {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    font-weight: 600;
    color: var(--text-color-dark);
    margin-bottom: 5px;
}
.category-progress-item .progress-fill {
    height: 6px;
    background: var(--primary-color);
    transition: width 0.3s ease;
    border-radius: 10px;
}
.category-progress-item .progress-fill.warning {
    background: var(--warning-color);
}
.category-progress-item .progress-fill.danger {
    background: var(--pagar-color);
}
/* Novo: Estilos para Calendário Financeiro */
.financial-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    font-size: 0.85em;
    text-align: center;
}
.calendar-header {
    font-weight: 700;
    padding: 5px 0;
    color: var(--header-color-dark);
}
.calendar-day {
    padding: 5px;
    border-radius: 8px;
    min-height: 50px;
    position: relative;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
}
.calendar-day-number {
    font-weight: 700;
    display: block;
    margin-bottom: 3px;
}
.day-pagar {
    color: var(--pagar-color);
    font-weight: 600;
    font-size: 0.75em;
}
.day-receber {
    color: var(--receber-color);
    font-weight: 600;
    font-size: 0.75em;
}
.day-has-events {
    box-shadow: 0 0 10px rgba(102,126,234,0.5);
    border-color: var(--primary-color);
}
/* Novo: Modo Compacto/Expandido (apenas toggle visual para a tabela) */
.table-compact td {
    padding: 8px 5px !important;
}
.table-compact .badge {
    padding: 4px 8px;
    font-size: 0.7em;
}
.table-compact .actions button {
    padding: 4px 8px;
    font-size: 0.8em;
}
@media(max-width:768px){
  .content{ grid-template-columns:1fr; }
  .triple-grid { grid-template-columns: 1fr; }
  header h1 { font-size:1.8em; }
  .card-value { font-size:1.5em; }
  table { font-size:0.9em; }
  th, td { padding:10px 5px; }
  .filter-controls > div {
      min-width: 100%;
  }
  .status-filters {
      justify-content: center;
  }
  .status-filter-btn {
      font-size: 0.85em;
      padding: 6px 12px;
  }
  .cards-summary { grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); }
  .actions button { /* Ajuste para botões de ação na tabela em mobile */
        margin-bottom: 5px;
    }
}
</style>
</head>
<body>
<button class="theme-toggle-btn" onclick="toggleTheme()">☀️ Modo Diurno</button>
<div class="container" id="mainContainer">
<header>
<h1>💰 Controle Financeiro</h1>
<div class="sync-status" id="syncStatus">
  <div class="dot"></div>
  <span id="syncText">Sincronizado</span>
</div>
</header>
<div class="cards-summary">
    <div class="card card-pagar"><div class="card-label">Total a Pagar</div><div class="card-value" id="totalPagar">R$ 0,00</div></div>
    <div class="card card-receber"><div class="card-label">Total a Receber</div><div class="card-value" id="totalReceber">R$ 0,00</div></div>
    <div class="card card-saldo"><div class="card-label">Saldo do Dia</div><div class="card-value" id="totalDia">R$ 0,00</div></div>
    <div class="card card-vencido"><div class="card-label">Contas Vencidas</div><div class="card-value" id="totalVencidos">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Vencem 7 Dias</div><div class="card-value" id="vencemSeteDias">R$ 0,00</div></div>
    <div class="card card-pagar"><div class="card-label">Gasto Hoje</div><div class="card-value" id="gastoHoje">R$ 0,00</div></div>
    <div class="card" id="cardSobraMes">
        <div class="card-label">Sobra/Falta (Mês)</div>
        <div class="card-value" id="sobraFaltaMes">R$ 0,00</div>
        <div style="font-size: 0.8em; margin-top: 8px; color: #b0b0b0;">Média 3M: <span id="media3Meses">R$ 0,00</span></div>
    </div>
    <div class="card card-meta" onclick="editarMeta('global')">
        <div class="edit-hint">✏️ Clique para editar</div>
        <div class="card-label" id="metaLabel">Meta de Gastos (Mês)</div>
        <div class="card-value" id="metaValor">R$ 0,00</div>
        <div class="progress-bar">
            <div class="progress-fill" id="metaProgress"></div>
        </div>
        <div style="font-size: 0.85em; margin-top: 8px; color: #b0b0b0;" id="metaPercentual">0% utilizado</div>
    </div>
</div>
<div class="content">
<div class="form-section">
<h2>📝 Novo Registro (Atalho: Pressione '+' ou 'n' para Focar)</h2>
<form id="financeForm">
<input type="hidden" id="row">
<input type="hidden" id="sheetRowId">
<div class="form-group">
<label for="data">Data</label>
<input type="date" id="data" required>
</div>
<div class="form-group">
<label for="tipo">Tipo</label>
<select id="tipo" required onchange="toggleParcelaRecorrente()">
<option value="Pagar">Pagar</option>
<option value="Receber">Receber</option>
</select>
</div>
<div class="form-group">
<label for="descricao">Descrição</label>
<input type="text" id="descricao" placeholder="Ex: Aluguel, Salário..." required>
</div>
<div class="form-group">
    <label for="categoria">Categoria (Sugestão 8: Metas por Categoria)</label>
    <select id="categoria" required>
        <option value="">Selecione a Categoria</option>
        <option value="Salário/Renda">Salário/Renda</option>
        <option value="Investimento">Investimento</option>
        <option value="Alimentação">Alimentação</option>
        <option value="Moradia/Aluguel">Moradia/Aluguel</option>
        <option value="Transporte">Transporte</option>
        <option value="Lazer">Lazer</option>
        <option value="Saúde">Saúde</option>
        <option value="Educação">Educação</option>
        <option value="Outros">Outros</option>
    </select>
    <div id="categoryMetaIndicator" style="font-size: 0.8em; margin-top: 5px; color: var(--meta-color);"></div>
</div>
<div class="form-group">
<label for="valor">Valor</label>
<input type="number" id="valor" placeholder="0,00" required step="0.01">
</div>
<div class="form-group" id="parcelamentoGroup" style="display: none;">
    <label for="parcelas">Número de Parcelas</label>
    <input type="number" id="parcelas" placeholder="1" min="1" value="1" onchange="toggleParcelaRecorrente()">
</div>
<div class="form-group" id="recorrenciaGroup" style="display: none;">
    <label for="recorrencia">Marcar como Recorrente (Mensal)</label>
    <select id="recorrencia">
        <option value="Nao">Não</option>
        <option value="Sim">Sim, Mensal</option>
    </select>
    <div style="font-size: 0.8em; color: var(--warning-color); margin-top: 5px;">* Criará lançamentos automáticos no próximo mês.</div>
</div>
<div class="form-group">
<label for="status">Status</label>
<select id="status" required>
<option value="Pendente">Pendente</option>
<option value="Pago">Pago</option>
<option value="Recebido">Recebido</option>
</select>
</div>
<div class="form-group">
<label for="conta">Conta/Carteira (Sugestão 6 - Simplificada)</label>
<select id="conta">
    <option value="Conta Corrente">Conta Corrente</option>
    <option value="Poupança">Poupança</option>
    <option value="Cartão de Crédito">Cartão de Crédito</option>
    <option value="Carteira">Carteira (Dinheiro)</option>
</select>
</div>
<div class="form-group">
<label for="campo2">Campo Adicional 2</label>
<input type="text" id="campo2" placeholder="Opcional">
</div>
<div class="form-group">
<label for="campo3">Campo Adicional 3</label>
<input type="text" id="campo3" placeholder="Opcional">
</div>
<button type="submit" class="btn-primary">💾 Salvar Registro</button>
</form>
</div>
<div class="chart-section">
<h2>📊 Gastos por Categoria (Pendentes)</h2>
<canvas id="graficoTipo"></canvas>
<div class="category-progress-container">
    <h3 style="font-size: 1.1em; margin-bottom: 15px; color: var(--meta-color);">Metas de Gastos por Categoria</h3>
    <div id="categoryMetasSummary">
        <div style="text-align: center; color: #b0b0b0;">Defina metas ao lado.</div>
    </div>
</div>
</div>
</div>
<div class="content triple-grid">
    <div class="chart-section">
        <h2>📈 Fluxo de Caixa (Entradas vs Saídas)</h2>
        <canvas id="graficoFluxoCaixa"></canvas>
    </div>
    <div class="chart-section">
        <h2>📉 Comparativo Mensal (Mês Atual vs Anterior)</h2>
        <canvas id="graficoComparativoMensal"></canvas>
    </div>
    <div class="chart-section card-meta" onclick="editarMeta('objetivo')" style="cursor: pointer;">
        <div class="edit-hint">✏️ Clique para editar</div>
        <h2>🎯 Objetivo de Economia/Investimento</h2>
        <div id="objetivoCardContent">
            <p style="color: var(--receber-color); font-weight: 600;">
                Meta: <span id="objetivoValorDisplay">R$ 0,00</span> em <span id="objetivoMesesDisplay">0</span> meses.
            </p>
            <p style="font-size: 1.5em; margin: 15px 0;">
                Poupar/Investir: <span id="valorMensalPoupar" class="summary-value-receber">R$ 0,00/mês</span>
            </p>
            <div style="font-size: 0.85em; color: #b0b0b0;">
                (Baseado na sua meta de <span id="objetivoMesesAux">0</span> meses.)
            </div>
        </div>
    </div>
</div>
<div class="content full-width-grid">
<div class="table-section">
<h2>📋 Registros</h2>
<div class="loading" id="loading">⏳ Sincronizando...</div>
<div class="status-filters">
    <button class="status-filter-btn filter-todos active" onclick="filtrarPorStatus('todos')">
        🔍 Todos <span class="filter-count" id="countTodos">0</span>
    </button>
    <button class="status-filter-btn filter-pendente" onclick="filtrarPorStatus('Pendente')">
        ⏳ Pendentes <span class="filter-count" id="countPendente">0</span>
    </button>
    <button class="status-filter-btn filter-pago" onclick="filtrarPorStatus('Pago')">
        ✅ Pagos <span class="filter-count" id="countPago">0</span>
    </button>
    <button class="status-filter-btn filter-recebido" onclick="filtrarPorStatus('Recebido')">
        💰 Recebidos <span class="filter-count" id="countRecebido">0</span>
    </button>
    <button class="status-filter-btn filter-pagar" onclick="filtrarPorStatus('tipo-pagar')">
        💸 A Pagar <span class="filter-count" id="countPagar">0</span>
    </button>
    <button class="status-filter-btn filter-receber" onclick="filtrarPorStatus('tipo-receber')">
        💵 A Receber <span class="filter-count" id="countReceber">0</span>
    </button>
</div>
<div class="filter-controls">
    <div class="filter-item-large">
        <label for="buscar" style="margin-bottom: 5px; font-size: 0.8em; color:var(--primary-color);">Buscar Texto/Avançado</label>
        <input type="text" id="buscar" placeholder="🔍 Descrição, data, tipo ou conta..." style="width:100%; padding:12px 15px; border-radius:10px;">
    </div>
    <div class="filter-item">
        <label for="filtroCategoria" style="margin-bottom: 5px; font-size: 0.8em;">Filtrar Categoria</label>
        <select id="filtroCategoria" style="padding:10px 15px;" onchange="aplicarFiltros()">
            <option value="all">Todas Categorias</option>
            <option value="Salário/Renda">Salário/Renda</option>
            <option value="Investimento">Investimento</option>
            <option value="Alimentação">Alimentação</option>
            <option value="Moradia/Aluguel">Moradia/Aluguel</option>
            <option value="Transporte">Transporte</option>
            <option value="Lazer">Lazer</option>
            <option value="Saúde">Saúde</option>
            <option value="Educação">Educação</option>
            <option value="Outros">Outros</option>
        </select>
    </div>
    <div class="filter-item">
        <label for="filtroSalvo" style="margin-bottom: 5px; font-size: 0.8em;">Filtros Salvos</label>
        <select id="filtroSalvo" style="padding:10px 15px;" onchange="carregarFiltroSalvo(this.value)">
            <option value="">Nenhum</option>
            <option value="alimentacao90">Gastos Alimentação (90 dias)</option>
            </select>
    </div>
    <div class="filter-item">
        <label for="filtroPeriodo" style="margin-bottom: 5px; font-size: 0.8em;">Período Dinâmico</label>
        <select id="filtroPeriodo" style="padding:10px 15px;">
            <option value="all">Todos os Registros</option>
            <option value="1" selected>Dia Atual</option>
            <option value="2-30">Últimos 30 Dias (Excluindo o Dia Atual)</option>
            <option value="45">Últimos 45 Dias</option>
            <option value="60">Últimos 60 Dias</option>
            <option value="75">Últimos 75 Dias</option>
            <option value="90">Últimos 90 Dias</option>
            <option value="120">Últimos 120 Dias</option>
            <option value="150">Últimos 150 Dias</option>
            <option value="180">Últimos 180 Dias</option>
            <option value="customDays">Outra Quantidade de Dias</option>
        </select>
    </div>
    <div class="filter-item" id="customDaysInput" style="display:none;">
        <label for="diasCustomizados" style="margin-bottom: 5px; font-size: 0.8em;">Quantos Dias Retroativos?</label>
        <input type="number" id="diasCustomizados" placeholder="Ex: 250" style="padding:10px 15px; min-width: 150px;">
    </div>
    <div class="filter-item">
        <label for="dataInicio" style="margin-bottom: 5px; font-size: 0.8em;">Início (Customizado)</label>
        <input type="date" id="dataInicio" style="padding:10px 15px;">
    </div>
    <div class="filter-item">
        <label for="dataFim" style="margin-bottom: 5px; font-size: 0.8em;">Fim (Customizado)</label>
        <input type="date" id="dataFim" style="padding:10px 15px;">
    </div>
    <button class="btn-filter" id="btnFiltrarData" style="min-width:120px; height: 45px; padding:10px 20px; align-self:flex-end;">Filtrar Customizado</button>
    <button class="btn-filter" id="btnFiltrarFav" style="height: 45px; padding:10px 20px; align-self:flex-end;">⭐ Apenas Favoritos</button>
    <button class="btn-primary" onclick="toggleCompactMode(this)" style="width: auto; height: 45px; padding:10px 20px; align-self:flex-end; background: #667eea;">↔️ Modo Compacto</button>
    <button class="btn-primary export-btn" onclick="exportarExcel()" style="width: auto; height: 45px; padding:10px 20px; align-self:flex-end;">📥 Exportar Excel</button>
    <button class="btn-primary export-btn" onclick="alert('Funcionalidade de PDF Otimizado em desenvolvimento!')" style="width: auto; height: 45px; padding:10px 20px; align-self:flex-end; background: #fa709a;">🖨️ Exportar PDF</button>
</div>
<div class="filter-summary" id="periodSummary">
    <span>Período Filtrado:</span>
    <span>Total Pagar: <span class="summary-value-pagar" id="summaryPagar"></span></span>
    <span>Total Receber: <span class="summary-value-receber" id="summaryReceber"></span></span>
    <span>Saldo Período: <span class="summary-value-saldo" id="summarySaldo"></span></span>
</div>
<table id="tabelaFinance">
<thead>
<tr>
<th>Fav</th>
<th>Data</th><th>Tipo</th><th>Descrição</th><th>Categoria</th><th>Valor</th><th>Conta</th><th>Status</th><th>Campos</th><th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="content triple-grid">
    <div class="chart-section">
        <h2>📈 Gastos por Dia (Últimos 7 dias)</h2>
        <canvas id="graficoDiario"></canvas>
    </div>
    <div class="chart-section">
        <h2>📉 Gastos Mensais por Categoria (Últimos 12 meses)</h2>
        <canvas id="graficoMensal"></canvas>
    </div>
    <div class="chart-section">
        <h2>📅 Calendário Financeiro (Mês Atual)</h2>
        <div id="calendarHeader" style="font-weight: 700; margin-bottom: 10px; text-align: center;">Mês/Ano</div>
        <div class="financial-calendar" id="financialCalendar">
            <div class="calendar-header">Dom</div>
            <div class="calendar-header">Seg</div>
            <div class="calendar-header">Ter</div>
            <div class="calendar-header">Qua</div>
            <div class="calendar-header">Qui</div>
            <div class="calendar-header">Sex</div>
            <div class="calendar-header">Sáb</div>
        </div>
        <div style="font-size: 0.8em; color: #b0b0b0; margin-top: 15px; text-align: center;">* Clique no dia para ver detalhes.</div>
    </div>
</div>
<div class="content full-width-grid" style="text-align: center;">
    <div class="form-section">
        <h2>🏆 Gamificação e Conquistas!</h2>
        <p style="color: var(--receber-color); font-weight: 600;">
            Continue economizando para ganhar a badge **"Mestre das Finanças"**!
        </p>
        <div style="font-size: 0.9em; margin-top: 10px; color: #b0b0b0;">
            (Sugestão 33: Implementação da lógica de pontuação e conquistas seria via *backend*.)
        </div>
    </div>
</div>
</div>
<div class="fab-container" id="fabContainer">
    <div class="quick-menu" id="quickMenu">
        <button class="btn-receber" onclick="focarFormulario('Receber')">💵 + Receber</button>
        <button class="btn-pagar" onclick="focarFormulario('Pagar')">💸 + Pagar</button>
    </div>
    <button class="fab-btn" onclick="toggleQuickMenu()">+</button>
</div>
<script>
let registros = [];
let chart;
let chartDiario;
let chartMensal;
let chartFluxoCaixa;
let chartCompMensal;
let mostraApenasFav = false;
let currentTheme = localStorage.getItem('theme') || 'dark';
let filtroStatusAtual = 'todos';
let filtroCategoriaAtual = 'all';
// Sugestão 8: Metas por Categoria
let metasPorCategoria = JSON.parse(localStorage.getItem('metasPorCategoria')) || {
    "Alimentação": 800,
    "Moradia/Aluguel": 1500,
    "Transporte": 300
};
// Sugestão 9/10: Planejamento (Objetivo de economia)
let objetivoEconomia = parseFloat(localStorage.getItem('objetivoEconomia')) || 10000;
let objetivoMeses = parseInt(localStorage.getItem('objetivoMeses')) || 12;
let metaTipo = localStorage.getItem('metaTipo') || 'mensal';
let metaValor = parseFloat(localStorage.getItem('metaValor')) || 5000;
// Sugestão 28: Regras Automáticas
const regrasAutomacao = [
    { termo: "uber", categoria: "Transporte" },
    { termo: "ifood", categoria: "Alimentação" },
    { termo: "netflix", categoria: "Lazer" },
    { termo: "aluguel", categoria: "Moradia/Aluguel" }
];
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCkEbskP0tA-4Ii_9v1wS7z2_9yHP0nn-_GroK_Z4paEiurRMz6Iole6902c00FR-Q/exec";

const formatarMoeda = valor => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
    applyTheme();
}
function applyTheme() {
    document.documentElement.setAttribute('data-theme', currentTheme);
    const themeButton = document.querySelector('.theme-toggle-btn');
    if (currentTheme === 'light') {
        themeButton.innerHTML = '🌙 Modo Noturno';
    } else {
        themeButton.innerHTML = '☀️ Modo Diurno';
    }
    // Atualizar gráficos com novo tema
    if(chart) atualizarGraficos(registros); 
}
function corrigirData(dataInput) {
  const data = new Date(dataInput + 'T12:00:00'); 
  const ano = data.getFullYear();
  const mes = String(data.getMonth() + 1).padStart(2, '0');
  const dia = String(data.getDate()).padStart(2, '0');
  return `${ano}-${mes}-${dia}`;
}
function mostrarLoading(show) {
  const loading = document.getElementById("loading");
  if(show) loading.classList.add("show");
  else loading.classList.remove("show");
}
function atualizarStatusSync(sincronizado) {
  const status = document.getElementById("syncStatus");
  const text = document.getElementById("syncText");
  if(sincronizado) {
    status.classList.remove("offline");
    text.innerText = "✓ Sincronizado";
  } else {
    status.classList.add("offline");
    text.innerText = "⚠ Offline - Dados locais";
  }
}
// Sugestão 2: Card de Economia/Sobra do Mês e Sugestão 20/21/22: Análises
function atualizarCardsGlobais(dataList) {
    let totalPagarGlobal=0,totalReceberGlobal=0;
    let gastoHojeGlobal = 0, gastoMesGlobal = 0;
    let totalVencidos = 0;
    let vencemSeteDias = 0;
    let dadosMensais = {}; // Para Sobra/Falta do Mês
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const hojeStr = hoje.toISOString().split('T')[0];
    const limiteSeteDias = new Date(hoje);
    limiteSeteDias.setDate(hoje.getDate() + 7);
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();
    dataList.forEach(r => {
        const dataRegistro = new Date(r.data + 'T12:00:00'); 
        const valor = parseFloat(r.valor);
        const mesAno = dataRegistro.getFullYear() + '-' + String(dataRegistro.getMonth() + 1).padStart(2, '0');
        if (!dadosMensais[mesAno]) {
            dadosMensais[mesAno] = { entrada: 0, saida: 0, saldo: 0 };
        }
        // Soma apenas os valores de status "Pendente" para os cards "Total a Pagar" e "Total a Receber"
        if(r.tipo==="Pagar") {
            if(r.status==="Pendente") totalPagarGlobal += valor;
            dadosMensais[mesAno].saida += valor;
        } else if(r.tipo==="Receber") {
            if(r.status==="Pendente") totalReceberGlobal += valor;
            dadosMensais[mesAno].entrada += valor;
        }
        // Contas Pagas (ou Recebidas) no dia de hoje
        if(r.data === hojeStr && r.tipo==="Pagar" && r.status === "Pago") {
            gastoHojeGlobal += valor;
        }
        // Gasto total (Pago) no mês
        if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo==="Pagar" && r.status === "Pago") {
            gastoMesGlobal += valor;
        }
        if(r.tipo==="Pagar" && r.status==="Pendente") {
            if (dataRegistro < hoje) {
                totalVencidos += valor;
            }
            if (dataRegistro >= hoje && dataRegistro <= limiteSeteDias) {
                 vencemSeteDias += valor;
            }
        }
    });
    // Calcular Saldo/Falta do Mês Atual (Com base em Pago/Recebido - Realizado)
    const mesAnoAtual = anoAtual + '-' + String(mesAtual + 1).padStart(2, '0');
    let entradaRealizadaMes = dataList.filter(r => 
        r.tipo === "Receber" && 
        (r.status === "Recebido" || r.status === "Pago") && // Recebido/Pago
        new Date(r.data + 'T12:00:00').getMonth() === mesAtual && 
        new Date(r.data + 'T12:00:00').getFullYear() === anoAtual
    ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
    let saidaRealizadaMes = dataList.filter(r => 
        r.tipo === "Pagar" && 
        (r.status === "Pago" || r.status === "Recebido") && // Pago/Recebido
        new Date(r.data + 'T12:00:00').getMonth() === mesAtual && 
        new Date(r.data + 'T12:00:00').getFullYear() === anoAtual
    ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
    const saldoMesAtual = entradaRealizadaMes - saidaRealizadaMes;
    // Calcular Média dos Últimos 3 Meses (Realizado)
    let saldoTotal3M = 0;
    let mesesContados = 0;
    for(let i = 1; i <= 3; i++) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const mesAnterior = d.getMonth();
        const anoAnterior = d.getFullYear();
        const entradaAnt = dataList.filter(r => 
            r.tipo === "Receber" && 
            (r.status === "Recebido" || r.status === "Pago") &&
            new Date(r.data + 'T12:00:00').getMonth() === mesAnterior && 
            new Date(r.data + 'T12:00:00').getFullYear() === anoAnterior
        ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
        const saidaAnt = dataList.filter(r => 
            r.tipo === "Pagar" && 
            (r.status === "Pago" || r.status === "Recebido") &&
            new Date(r.data + 'T12:00:00').getMonth() === mesAnterior && 
            new Date(r.data + 'T12:00:00').getFullYear() === anoAnterior
        ).reduce((sum, r) => sum + parseFloat(r.valor), 0);
        if (entradaAnt > 0 || saidaAnt > 0) {
            saldoTotal3M += (entradaAnt - saidaAnt);
            mesesContados++;
        }
    }
    const media3Meses = mesesContados > 0 ? saldoTotal3M / mesesContados : 0;
    document.getElementById("media3Meses").innerText = formatarMoeda(media3Meses);
    document.getElementById("sobraFaltaMes").innerText = formatarMoeda(saldoMesAtual);
    const cardSobra = document.getElementById("cardSobraMes");
    cardSobra.classList.remove('card-sobra', 'card-falta');
    if (saldoMesAtual >= 0) {
        cardSobra.classList.add('card-sobra');
    } else {
        cardSobra.classList.add('card-falta');
    }
    document.getElementById("totalPagar").innerText=formatarMoeda(totalPagarGlobal);
    document.getElementById("totalReceber").innerText=formatarMoeda(totalReceberGlobal);
    document.getElementById("totalDia").innerText=formatarMoeda(totalReceberGlobal-totalPagarGlobal); // Saldo Pendente
    document.getElementById("gastoHoje").innerText=formatarMoeda(gastoHojeGlobal);
    document.getElementById("totalVencidos").innerText=formatarMoeda(totalVencidos);
    document.getElementById("vencemSeteDias").innerText=formatarMoeda(vencemSeteDias);
    atualizarCardMeta(gastoHojeGlobal, gastoMesGlobal);
    atualizarCardObjetivo(); // Novo
    atualizarContadoresFiltros(dataList);
    atualizarCategoryMetas(dataList); // Sugestão 8
    renderizarCalendario(dataList); // Sugestão 12
}
function mostrarRegistros(lista){
  const tbody = document.querySelector("#tabelaFinance tbody");
  tbody.innerHTML="";
  // Atualizar cards com todos os registros (não apenas os filtrados da tabela)
  atualizarCardsGlobais(registros); 
  lista.forEach(r=>{
    const tr=document.createElement("tr");
    const tipoBadge=r.tipo==="Pagar"?"badge-pagar":"badge-receber";
    const statusBadge=r.status==="Pendente"?"badge-pendente":(r.status==="Pago"||r.status==="Recebido")?"badge-pago":"badge-pendente";
    const starClass = r.fav ? "star" : "star-empty";
    // Sugestão 4 e 5: Adicionar Recorrência e Parcela na descrição ou em Campos
    let camposAdicionais = `${r.campo2||'-'} ${r.campo3||''}`;
    if (r.recorrente === 'Sim') camposAdicionais += ' [RECORR.]';
    if (r.parcelaTotal && r.parcelaTotal > 1) camposAdicionais += ` [${r.parcelaAtual}/${r.parcelaTotal}]`;
    // Lógica para Pagamento Parcial (Mostra o valor original e o pago)
    let valorDisplay = formatarMoeda(parseFloat(r.valor));
    let acoesHtml = `<button class="btn-edit" onclick="editar(${r.row})">Editar</button><button class="btn-danger" onclick="excluir(${r.row})">Excluir</button>`;
    if (r.valorOriginal && parseFloat(r.valorOriginal) > parseFloat(r.valor)) {
        valorDisplay = `<span style="text-decoration:line-through; color:var(--pagar-color);">${formatarMoeda(parseFloat(r.valorOriginal))}</span> ${formatarMoeda(parseFloat(r.valor))}`;
    }
    // Adicionar botão de Pagamento Parcial apenas se for Pagar e Pendente
    if (r.tipo === 'Pagar' && r.status === 'Pendente') {
         acoesHtml = `<button class="btn-partial" onclick="pagamentoParcial(${r.row})">Parcial</button> ` + acoesHtml;
    }
    tr.innerHTML=`
      <td><span class="${starClass}" onclick="toggleFav(${r.row})" style="cursor:pointer;">★</span></td>
      <td>${new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR')}</td>
      <td><span class="badge ${tipoBadge}">${r.tipo}</span></td>
      <td>${r.descricao}</td>
      <td>${r.categoria || '-'}</td>
      <td><strong>${valorDisplay}</strong></td>
      <td>${r.conta || 'N/A'}</td>
      <td><span class="badge ${statusBadge}" onclick="mudarStatus(${r.row})" style="cursor:pointer;">${r.status}</span></td>
      <td>${camposAdicionais}</td>
      <td>
        <div class="actions">
          ${acoesHtml}
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
  atualizarGraficos(registros); 
}
function atualizarGraficos(dataList){
  const fontColor = currentTheme === 'light' ? '#333333' : '#e0e0e0';
  const gridColor = currentTheme === 'light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
  // FILTROS ATUALIZADOS: Gráficos de Gastos devem usar o status "Pago" (Realizado)
  const gastosRealizados = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago");
  const pagamentosPendentes = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pendente");
  const entradasRealizadas = dataList.filter(r => r.tipo === "Receber" && r.status === "Recebido");
  const saidasRealizadas = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago");
  // Gráfico 1: Gastos por Categoria (Pizza) - Apenas Pendentes para Lembrar
  const gastosPendentesPorCategoria = pagamentosPendentes.reduce((acc, r) => {
    acc[r.categoria] = (acc[r.categoria] || 0) + parseFloat(r.valor);
    return acc;
  }, {});
  const categoriasLabels = Object.keys(gastosPendentesPorCategoria);
  const categoriasValores = Object.values(gastosPendentesPorCategoria);
  const ctx=document.getElementById('graficoTipo').getContext('2d');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels: categoriasLabels,
      datasets:[{
        data: categoriasValores,
        backgroundColor:['#f093fb','#4facfe','#667eea','#fbc531','#a18cd1','#fa709a','#00d2ff','#ee5a6f','#c9cbcf'],
        borderColor: currentTheme === 'light' ? '#ffffff' : '#1f1f2e',
        borderWidth:3
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:fontColor,font:{size:12,weight:'bold'}}},
        title: {display: true, text: 'Pendentes a Pagar por Categoria', color: fontColor}
      }
    }
  });
  // Gráfico 2: Fluxo de Caixa (Linha ao longo do tempo - Realizado)
  const dadosFluxo = {};
  const dataInicioFluxo = new Date();
  dataInicioFluxo.setMonth(dataInicioFluxo.getMonth() - 5); // Últimos 6 meses
  dataInicioFluxo.setDate(1);
  entradasRealizadas.concat(saidasRealizadas).forEach(r => {
    const dataRegistro = new Date(r.data + 'T12:00:00');
    if (dataRegistro >= dataInicioFluxo) {
        const mesAno = dataRegistro.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
        if (!dadosFluxo[mesAno]) dadosFluxo[mesAno] = { entrada: 0, saida: 0 };
        if (r.tipo === "Receber") dadosFluxo[mesAno].entrada += parseFloat(r.valor);
        else if (r.tipo === "Pagar") dadosFluxo[mesAno].saida += parseFloat(r.valor);
    }
  });
  const mesesFluxo = Object.keys(dadosFluxo).sort((a, b) => {
    const [mesA, anoA] = a.split('/');
    const [mesB, anoB] = b.split('/');
    // Tenta parsear como data
    let dateA, dateB;
    try {
        dateA = new Date(`01 ${mesA} 20${anoA}`);
        dateB = new Date(`01 ${mesB} 20${anoB}`);
    } catch (e) {
        // Fallback for sorting if date parsing fails (e.g. invalid short month name)
        return a.localeCompare(b);
    }
    return dateA - dateB;
  });
  const ctxFluxoCaixa = document.getElementById('graficoFluxoCaixa').getContext('2d');
  if(chartFluxoCaixa) chartFluxoCaixa.destroy();
  chartFluxoCaixa = new Chart(ctxFluxoCaixa, {
    type: 'bar',
    data: {
      labels: mesesFluxo,
      datasets: [
        {
          label: 'Entradas (Recebido)',
          data: mesesFluxo.map(m => dadosFluxo[m].entrada),
          backgroundColor: var(--receber-color),
          stack: 'stack1'
        },
        {
          label: 'Saídas (Pago)',
          data: mesesFluxo.map(m => -dadosFluxo[m].saida), // Valores negativos para despesas
          backgroundColor: var(--pagar-color),
          stack: 'stack1'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}},
        title: {display: true, text: 'Fluxo Mensal (Realizado)', color: fontColor}
      },
      scales: {
        x: {ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {ticks: {color: fontColor, callback: function(value) { return formatarMoeda(value); }}, grid: {color: gridColor}}
      }
    }
  });
  // Gráfico 3: Comparativo Mensal (Mês Atual vs Mês Anterior - Realizado)
  const hoje = new Date();
  const mesAtualNome = hoje.toLocaleDateString('pt-BR', { month: 'long' });
  const mesAnterior = new Date(hoje.setMonth(hoje.getMonth() - 1));
  const mesAnteriorNome = mesAnterior.toLocaleDateString('pt-BR', { month: 'long' });
  const categoriaLabelsComp = ["Receitas (Realizado)", "Despesas (Realizado)"];
  let receitaAtual = 0, despesaAtual = 0;
  let receitaAnterior = 0, despesaAnterior = 0;
  dataList.forEach(r => {
    const dataRegistro = new Date(r.data + 'T12:00:00');
    const valor = parseFloat(r.valor);
    // Filtro para o Mês Atual (realizado)
    if (dataRegistro.getMonth() === new Date().getMonth() && dataRegistro.getFullYear() === new Date().getFullYear()) {
      if (r.tipo === "Receber" && r.status === "Recebido") receitaAtual += valor;
      else if (r.tipo === "Pagar" && r.status === "Pago") despesaAtual += valor;
    }
    // Filtro para o Mês Anterior (realizado)
    if (dataRegistro.getMonth() === mesAnterior.getMonth() && dataRegistro.getFullYear() === mesAnterior.getFullYear()) {
      if (r.tipo === "Receber" && r.status === "Recebido") receitaAnterior += valor;
      else if (r.tipo === "Pagar" && r.status === "Pago") despesaAnterior += valor;
    }
  });
  const ctxCompMensal = document.getElementById('graficoComparativoMensal').getContext('2d');
  if(chartCompMensal) chartCompMensal.destroy();
  chartCompMensal = new Chart(ctxCompMensal, {
    type: 'bar',
    data: {
      labels: categoriaLabelsComp,
      datasets: [
        {
          label: `Mês Anterior (${mesAnteriorNome})`,
          data: [receitaAnterior, despesaAnterior],
          backgroundColor: 'rgba(102,126,234, 0.6)' 
        },
        {
          label: `Mês Atual (${mesAtualNome})`,
          data: [receitaAtual, despesaAtual],
          backgroundColor: 'rgba(79,175,254, 0.8)' 
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {position: 'bottom', labels: {color: fontColor, font: {size: 12, weight: 'bold'}}},
        title: {display: true, text: 'Comparativo Receitas/Despesas (Realizado)', color: fontColor}
      },
      scales: {
        x: {ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {beginAtZero: true, ticks: {color: fontColor, callback: function(value) { return formatarMoeda(value); }}, grid: {color: gridColor}}
      }
    }
  });
  // Gráfico 4: Gastos Diários (Linha - Realizado)
  const gastosPorDia = {};
  const hojeDia = new Date();
  for(let i = 6; i >= 0; i--) {
    const data = new Date(hojeDia);
    data.setDate(data.getDate() - i);
    const chave = data.toISOString().split('T')[0];
    gastosPorDia[chave] = 0;
  }
  gastosRealizados.forEach(r => {
    if(gastosPorDia.hasOwnProperty(r.data)) {
      gastosPorDia[r.data] += parseFloat(r.valor);
    }
  });
  const diasLabels = Object.keys(gastosPorDia).map(d => new Date(d + 'T12:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'}));
  const diasValores = Object.values(gastosPorDia);
  const ctxDiario = document.getElementById('graficoDiario').getContext('2d');
  if(chartDiario) chartDiario.destroy();
  chartDiario = new Chart(ctxDiario, {
    type: 'line',
    data: {
      labels: diasLabels,
      datasets: [{
        label: 'Gastos Diários (Realizado)',
        data: diasValores,
        borderColor: var(--pagar-color),
        backgroundColor: 'rgba(240, 147, 251, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: var(--pagar-color),
        pointBorderColor: currentTheme === 'light' ? '#333' : '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}}
      },
      scales: {
        y: {beginAtZero: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        x: {ticks: {color: fontColor}, grid: {color: gridColor}}
      }
    }
  });
  // Gráfico 5: Gastos Mensais por Categoria (Barra Empilhada - Realizado)
  const gastosPorMesECategoria = {};
  const categorias = ["Alimentação", "Moradia/Aluguel", "Transporte", "Lazer", "Saúde", "Educação", "Outros"];
  const mesesLabels = [];
  const hojeMes = new Date().getMonth();
  const hojeAno = new Date().getFullYear();
  for(let i = 0; i < 12; i++) {
    const d = new Date();
    d.setMonth(d.getMonth() - i);
    const mes = d.getMonth();
    const ano = d.getFullYear();
    const nomeMes = new Date(ano, mes, 1).toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
    mesesLabels.push(nomeMes);
    gastosPorMesECategoria[nomeMes] = {};
    categorias.forEach(cat => gastosPorMesECategoria[nomeMes][cat] = 0);
  }
  mesesLabels.reverse(); // Garante a ordem cronológica correta
  gastosRealizados.forEach(r => {
    if(categorias.includes(r.categoria)) {
      const dataParse = new Date(r.data + 'T12:00:00');
      const nomeMes = dataParse.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'});
      if(gastosPorMesECategoria.hasOwnProperty(nomeMes)) {
        gastosPorMesECategoria[nomeMes][r.categoria] += parseFloat(r.valor);
      }
    }
  });
  const categoryColors = {
      "Alimentação": "#ff6384", "Moradia/Aluguel": "#36a2eb", "Transporte": "#ff9f40", 
      "Lazer": "#4bc0c0", "Saúde": "#9966ff", "Educação": "#ffcd56", "Outros": "#c9cbcf"
  };
  const datasets = categorias.map(cat => ({
      label: cat,
      data: mesesLabels.map(mes => gastosPorMesECategoria[mes][cat]),
      backgroundColor: categoryColors[cat]
  }));
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  if(chartMensal) chartMensal.destroy();
  chartMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: mesesLabels,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {labels: {color: fontColor, font: {size: 12, weight: 'bold'}}},
        title: {display: true, text: 'Total Gasto por Categoria/Mês (Realizado)', color: fontColor}
      },
      scales: {
        x: {stacked: true, ticks: {color: fontColor}, grid: {color: gridColor}},
        y: {stacked: true, beginAtZero: true, ticks: {color: fontColor, callback: function(value) { return formatarMoeda(value); }}, grid: {color: gridColor}}
      }
    }
  });
}
// Sugestão 4 e 5: Lógica de parcelamento e recorrência
function toggleParcelaRecorrente() {
    const tipo = document.getElementById("tipo").value;
    const parcelamentoGroup = document.getElementById("parcelamentoGroup");
    const recorrenciaGroup = document.getElementById("recorrenciaGroup");
    if (tipo === 'Pagar') {
        parcelamentoGroup.style.display = 'block';
        recorrenciaGroup.style.display = 'block';
    } else {
        parcelamentoGroup.style.display = 'none';
        document.getElementById("parcelas").value = 1; // Reset
        recorrenciaGroup.style.display = 'block'; // Receita pode ser recorrente
    }
    // Se tiver mais de 1 parcela, não pode ser recorrente
    if (parseInt(document.getElementById("parcelas").value) > 1) {
        document.getElementById("recorrencia").value = 'Nao';
        document.getElementById("recorrencia").disabled = true;
    } else {
        document.getElementById("recorrencia").disabled = false;
    }
}
async function enviarParaPlanilha(dados){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify(dados)
    });
    const result = await resp.json();
    atualizarStatusSync(true);
    mostrarLoading(false);
    return result;
  }catch(e){
    console.error("Erro ao sincronizar:",e);
    atualizarStatusSync(false);
    mostrarLoading(false);
    alert("⚠️ Erro ao sincronizar. Verifique sua conexão e a URL do Web App.");
  }
}
async function carregarRegistros(){
  mostrarLoading(true);
  try{
    const resp = await fetch(WEB_APP_URL,{
      method:'POST',
      body:JSON.stringify({action:'get'})
    });
    const data = await resp.json();
    if(Array.isArray(data)) {
      // Usando 'r.categoria' como campo principal, 'r.campo1' como fallback para compatibilidade com o backend
      registros = data.map((r, idx) => ({
          ...r, 
          row: idx + 1, 
          fav: r.fav || false,
          categoria: r.categoria || r.campo1 || 'Outros',
          // campo1: r.categoria || r.campo1 || 'Outros', // Mantido para compatibilidade de envio, mas usar 'categoria' na lógica
          conta: r.conta || 'Conta Corrente', // Adiciona conta
          recorrente: r.recorrente || 'Nao', // Adiciona recorrente
          parcelaAtual: parseInt(r.parcelaAtual) || 1, // Adiciona parcelas
          parcelaTotal: parseInt(r.parcelaTotal) || 1,
          valorOriginal: r.valorOriginal ? parseFloat(r.valorOriginal) : null // Novo para Parcial
      }));
      atualizarStatusSync(true);
      aplicarFiltros(); 
      console.log("✓ Carregados " + registros.length + " registros");
    }
  }catch(e){
    console.error("Erro ao carregar:",e);
    atualizarStatusSync(false);
  }
  mostrarLoading(false);
}
// Sugestão 28: Lógica de Regras Automáticas
function aplicarRegrasAutomacao(descricao, categoria) {
    if (categoria && categoria !== 'Selecione a Categoria') return categoria;
    const termoNormalizado = descricao.toLowerCase().trim();
    for (const regra of regrasAutomacao) {
        if (termoNormalizado.includes(regra.termo)) {
            return regra.categoria;
        }
    }
    return categoria;
}
document.getElementById("financeForm").addEventListener("submit",function(e){
  e.preventDefault();
  const tipo=document.getElementById("tipo").value;
  const descricao=document.getElementById("descricao").value;
  const valor=parseFloat(document.getElementById("valor").value);
  const status=document.getElementById("status").value;
  let categoria=document.getElementById("categoria").value;
  const conta=document.getElementById("conta").value;
  const campo2=document.getElementById("campo2").value;
  const campo3=document.getElementById("campo3").value;
  const recorrente = document.getElementById("recorrencia").value;
  const parcelas = tipo === 'Pagar' ? parseInt(document.getElementById("parcelas").value) : 1;
  // Sugestão 28: Aplica a regra automática se a categoria não foi explicitamente selecionada
  categoria = aplicarRegrasAutomacao(descricao, categoria);
  if(!categoria || categoria === 'Selecione a Categoria') {
    alert("Preencha a Categoria (obrigatória).");
    return;
  }
  const row=document.getElementById("row").value;
  const sheetRowId=document.getElementById("sheetRowId").value;
  if(row) { // Edição de registro
    const idx = registros.findIndex(r=>r.id == sheetRowId);
    if(idx !== -1) {
      const registroExistente = registros[idx];
      const dadosRegistro = {
        data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status, 
        categoria, campo2, campo3, conta, recorrente,
        parcelaAtual: registroExistente.parcelaAtual, parcelaTotal: registroExistente.parcelaTotal,
        // Mantém valorOriginal se já existe, senão seta para null
        valorOriginal: registroExistente.valorOriginal || (registroExistente.valor !== valor ? registroExistente.valor : null) 
      };
      registros[idx]={...registroExistente,...dadosRegistro, row:parseInt(row)};
      enviarParaPlanilha({...registros[idx], action:'update', campo1: categoria}); // Envia categoria como campo1 para backend
    }
    document.getElementById("row").value="";
    document.getElementById("sheetRowId").value="";
  } else { // Novo registro (incluindo parcelamento)
    // Sugestão 4: Parcelamento (cria múltiplos registros)
    if(tipo === 'Pagar' && parcelas > 1) {
        for(let i = 1; i <= parcelas; i++) {
            const dataParcela = new Date(document.getElementById("data").value + 'T12:00:00');
            dataParcela.setMonth(dataParcela.getMonth() + (i - 1));
            const novoRegistro = {
                data: corrigirData(dataParcela.toISOString().split('T')[0]), 
                tipo, descricao: `${descricao} (${i}/${parcelas})`, 
                valor: valor, status, categoria, campo2, campo3, conta, 
                recorrente: 'Nao', 
                parcelaAtual: i, 
                parcelaTotal: parcelas,
                row: registros.length + i, 
                fav: false
            };
            registros.push(novoRegistro);
            enviarParaPlanilha({...novoRegistro, action:'add', campo1: categoria});
        }
    } 
    // Sugestão 5: Recorrência
    else if (recorrente === 'Sim') {
        const novoRegistro = {
            data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status, 
            categoria, campo2, campo3, conta, recorrente,
            parcelaAtual: 1, parcelaTotal: 1,
            row: registros.length + 1, fav: false
        };
        registros.push(novoRegistro);
        enviarParaPlanilha({...novoRegistro, action:'add', campo1: categoria});
        alert(`✅ Recorrente salvo! A rotina de automação criará os próximos lançamentos.`);
    }
    // Registro Simples
    else {
        const novoRegistro = {
            data: corrigirData(document.getElementById("data").value), tipo, descricao, valor, status, 
            categoria, campo2, campo3, conta, recorrente: 'Nao',
            parcelaAtual: 1, parcelaTotal: 1,
            row: registros.length + 1, fav: false
        };
        registros.push(novoRegistro);
        enviarParaPlanilha({...novoRegistro, action:'add', campo1: categoria});
    }
  }
  this.reset();
  document.getElementById("data").valueAsDate=new Date();
  document.getElementById("parcelas").value = 1;
  document.getElementById("recorrencia").value = 'Nao';
  toggleParcelaRecorrente(); // Restaura estado inicial
  mostraApenasFav = false;
  document.getElementById("btnFiltrarFav").classList.remove("active");
  aplicarFiltros(); 
  document.getElementById("descricao").focus();
});
document.getElementById("filtroPeriodo").addEventListener("change", function() {
    const customDaysInput = document.getElementById("customDaysInput");
    if (this.value === 'customDays') {
        customDaysInput.style.display = 'block';
    } else {
        customDaysInput.style.display = 'none';
        document.getElementById("diasCustomizados").value = '';
    }
    aplicarFiltros();
});
document.getElementById("diasCustomizados").addEventListener("input", aplicarFiltros);
// Sugestão 16: Pesquisa Avançada e Filtro por Categoria
function aplicarFiltros() {
    const termo = document.getElementById("buscar").value.toLowerCase();
    const categoriaFiltro = document.getElementById("filtroCategoria").value;
    const periodoSelecionado = document.getElementById("filtroPeriodo").value; 
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const summaryDiv = document.getElementById("periodSummary");
    let filtrados = registros;
    let totalPagarPeriodo = 0;
    let totalReceberPeriodo = 0;
    let dataFiltroAtivo = false;
    let dataInicioFiltro, dataFimFiltro;
    // Lógica de Período Dinâmico/Customizado
    if (periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999); 
        if (periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if (periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio; 
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1); 
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59'); 
        } else if (periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            } else {
                dataFiltroAtivo = false;
            }
        }
        else {
            const dias = parseInt(periodoSelecionado);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1)); 
            }
        }
        if (dataInicioFiltro && dataFimFiltro) {
            dataFiltroAtivo = true; 
        }
        dataInicioStr = '';
        dataFimStr = '';
    }
    if (dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        dataFiltroAtivo = true;
    }
    if (dataFiltroAtivo) {
        filtrados = filtrados.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }
    // Filtro por Status
    if (filtroStatusAtual !== 'todos') {
        if (filtroStatusAtual === 'tipo-pagar') {
            filtrados = filtrados.filter(r => r.tipo === 'Pagar');
        } else if (filtroStatusAtual === 'tipo-receber') {
            filtrados = filtrados.filter(r => r.tipo === 'Receber');
        } else {
            filtrados = filtrados.filter(r => r.status === filtroStatusAtual);
        }
    }
    // Filtro por Favorito
    if (mostraApenasFav) {
        filtrados = filtrados.filter(r => r.fav);
    }
    // Filtro por Categoria
    if (categoriaFiltro !== 'all') {
        filtrados = filtrados.filter(r => r.categoria === categoriaFiltro);
    }
    // Filtro por Termo (Busca Avançada)
    if (termo) {
        filtrados = filtrados.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.categoria.toLowerCase().includes(termo) ||
            r.conta.toLowerCase().includes(termo) || // Busca por Conta
            r.data.includes(termo)
        );
    }
    totalPagarPeriodo = filtrados.filter(r => r.tipo === "Pagar").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    totalReceberPeriodo = filtrados.filter(r => r.tipo === "Receber").reduce((sum, r) => sum + parseFloat(r.valor), 0);
    if (dataFiltroAtivo || mostraApenasFav || termo || filtroStatusAtual !== 'todos' || categoriaFiltro !== 'all') {
        document.getElementById("summaryPagar").innerText = formatarMoeda(totalPagarPeriodo);
        document.getElementById("summaryReceber").innerText = formatarMoeda(totalReceberPeriodo);
        document.getElementById("summarySaldo").innerText = formatarMoeda(totalReceberPeriodo - totalPagarPeriodo);
        summaryDiv.style.display = 'flex';
    } else {
        summaryDiv.style.display = 'none';
    }
    mostrarRegistros(filtrados);
}
document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("btnFiltrarData").addEventListener("click", aplicarFiltros);
document.getElementById("btnFiltrarFav").addEventListener("click", function(){
  mostraApenasFav = !mostraApenasFav;
  this.classList.toggle("active");
  aplicarFiltros();
});
// Sugestão 14: Filtros Salvos
function carregarFiltroSalvo(filtro) {
    if (filtro === 'alimentacao90') {
        document.getElementById('filtroPeriodo').value = '90';
        document.getElementById('filtroCategoria').value = 'Alimentação';
        document.getElementById('buscar').value = '';
        filtrarPorStatus('tipo-pagar'); 
        mostraApenasFav = false;
        document.getElementById("btnFiltrarFav").classList.remove("active");
    } 
    document.getElementById('filtroSalvo').value = ''; // Reset do select salvo
    aplicarFiltros();
}
// Sugestão 15: Modo Compacto/Expandido
function toggleCompactMode(button) {
    const table = document.getElementById('tabelaFinance');
    if (table.classList.contains('table-compact')) {
        table.classList.remove('table-compact');
        button.innerText = '↔️ Modo Compacto';
    } else {
        table.classList.add('table-compact');
        button.innerText = '↕️ Modo Expandido';
    }
}
function atualizarContadoresFiltros(dataList) {
    const countTodos = dataList.length;
    const countPendente = dataList.filter(r => r.status === "Pendente").length;
    const countPago = dataList.filter(r => r.status === "Pago").length;
    const countRecebido = dataList.filter(r => r.status === "Recebido").length;
    const countPagar = dataList.filter(r => r.tipo === "Pagar").length;
    const countReceber = dataList.filter(r => r.tipo === "Receber").length;
    document.getElementById("countTodos").innerText = countTodos;
    document.getElementById("countPendente").innerText = countPendente;
    document.getElementById("countPago").innerText = countPago;
    document.getElementById("countRecebido").innerText = countRecebido;
    document.getElementById("countPagar").innerText = countPagar;
    document.getElementById("countReceber").innerText = countReceber;
}
function filtrarPorStatus(tipo) {
    filtroStatusAtual = tipo;
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if(tipo === 'todos') {
        document.querySelector('.filter-todos').classList.add('active');
    } else if(tipo === 'Pendente') {
        document.querySelector('.filter-pendente').classList.add('active');
    } else if(tipo === 'Pago') {
        document.querySelector('.filter-pago').classList.add('active');
    } else if(tipo === 'Recebido') {
        document.querySelector('.filter-recebido').classList.add('active');
    } else if(tipo === 'tipo-pagar') {
        document.querySelector('.filter-pagar').classList.add('active');
    } else if(tipo === 'tipo-receber') {
        document.querySelector('.filter-receber').classList.add('active');
    }
    aplicarFiltros();
}
function atualizarCardMeta(gastoHoje, gastoMes) {
    const label = metaTipo === 'diario' ? 'Meta de Gastos (Dia)' : 'Meta de Gastos (Mês)';
    const gastoAtual = metaTipo === 'diario' ? gastoHoje : gastoMes;
    const percentual = metaValor > 0 ? (gastoAtual / metaValor * 100) : 0;
    document.getElementById("metaLabel").innerText = label;
    document.getElementById("metaValor").innerText = formatarMoeda(metaValor);
    document.getElementById("metaPercentual").innerText = `${percentual.toFixed(1)}% utilizado (${formatarMoeda(gastoAtual)} de ${formatarMoeda(metaValor)})`;
    const progressBar = document.getElementById("metaProgress");
    progressBar.style.width = Math.min(percentual, 100) + '%';
    progressBar.classList.remove('warning', 'danger');
    if(percentual >= 90) {
        progressBar.classList.add('danger');
    } else if(percentual >= 70) {
        progressBar.classList.add('warning');
    }
    // Sugestão 11: Alertas Inteligentes (Simplificado)
    if (percentual >= 80) {
        // Alerta de meta global (se estivesse no escopo, seria uma notificação push/popup)
        // alert(`🔔 Alerta de Meta: Você atingiu ${percentual.toFixed(0)}% da sua meta de gastos ${metaTipo === 'diario' ? 'diária' : 'mensal'}!`);
    }
}
// Novo: Sugestão 10 - Atualizar Card de Objetivo de Economia
function atualizarCardObjetivo() {
    const valorMensalNecessario = objetivoMeses > 0 ? objetivoEconomia / objetivoMeses : 0;
    document.getElementById("objetivoValorDisplay").innerText = formatarMoeda(objetivoEconomia);
    document.getElementById("objetivoMesesDisplay").innerText = objetivoMeses;
    document.getElementById("objetivoMesesAux").innerText = objetivoMeses;
    document.getElementById("valorMensalPoupar").innerText = formatarMoeda(valorMensalNecessario) + "/mês";
}
function editarMeta(type) {
    if (type === 'global') {
        const tipoAtual = metaTipo === 'diario' ? 'Diário' : 'Mensal';
        const novoTipo = prompt(`Tipo de Meta Atual: ${tipoAtual}
Digite:
1 - Para Meta Diária
2 - Para Meta Mensal`, metaTipo === 'diario' ? '1' : '2');
        if(novoTipo === '1') {
            metaTipo = 'diario';
        } else if(novoTipo === '2') {
            metaTipo = 'mensal';
        } else if(novoTipo !== null) {
            alert('Opção inválida! Use 1 para Diário ou 2 para Mensal.');
            return;
        } else {
            return;
        }
        const novoValor = prompt(`Meta de Gastos ${metaTipo === 'diario' ? 'Diária' : 'Mensal'}:
Valor Atual: R$ ${metaValor.toFixed(2)}
Digite o novo valor (ex: 5000):`, metaValor);
        if(novoValor !== null) {
            const valorParseado = parseFloat(novoValor.replace(',', '.'));
            if(!isNaN(valorParseado) && valorParseado > 0) {
                metaValor = valorParseado;
                localStorage.setItem('metaTipo', metaTipo);
                localStorage.setItem('metaValor', metaValor);
                const hoje = new Date();
                const hojeStr = hoje.toISOString().split('T')[0];
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                let gastoHoje = 0, gastoMes = 0;
                registros.forEach(r => {
                    const dataRegistro = new Date(r.data + 'T12:00:00');
                    const valor = parseFloat(r.valor);
                    if(r.data === hojeStr && r.tipo === "Pagar" && r.status === "Pago") gastoHoje += valor;
                    if(dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual && r.tipo === "Pagar" && r.status === "Pago") gastoMes += valor;
                });
                atualizarCardMeta(gastoHoje, gastoMes);
                alert(`✅ Meta ${metaTipo === 'diario' ? 'Diária' : 'Mensal'} atualizada para ${formatarMoeda(metaValor)}`);
            } else {
                alert('❌ Valor inválido! Digite um número positivo.');
            }
        }
    } else if (type === 'objetivo') { // Novo: Edição de Meta de Poupança/Investimento
        const novoObjetivo = prompt(`Objetivo de Economia/Investimento:
Valor Atual: R$ ${objetivoEconomia.toFixed(2)}
Digite o valor total do objetivo (ex: 10000):`, objetivoEconomia);
        if (novoObjetivo !== null) {
            const valorParseado = parseFloat(novoObjetivo.replace(',', '.'));
            if (!isNaN(valorParseado) && valorParseado > 0) {
                objetivoEconomia = valorParseado;
                localStorage.setItem('objetivoEconomia', objetivoEconomia);
            } else {
                alert('❌ Valor do Objetivo inválido! Digite um número positivo.');
                return;
            }
        } else {
            return;
        }
        const novosMeses = prompt(`Prazo (em meses) para o Objetivo:
Prazo Atual: ${objetivoMeses} meses
Digite o novo prazo (ex: 12):`, objetivoMeses);
        if (novosMeses !== null) {
            const mesesParseado = parseInt(novosMeses);
            if (!isNaN(mesesParseado) && mesesParseado > 0) {
                objetivoMeses = mesesParseado;
                localStorage.setItem('objetivoMeses', objetivoMeses);
            } else {
                alert('❌ Prazo inválido! Digite um número inteiro positivo.');
                return;
            }
        } else {
            return;
        }
        atualizarCardObjetivo();
        alert(`✅ Objetivo atualizado: ${formatarMoeda(objetivoEconomia)} em ${objetivoMeses} meses.`);
    } else {
        // Sugestão 8: Edição de Metas por Categoria
        const cat = prompt(`Digite a categoria para definir/editar a meta (ex: Alimentação):`);
        if (!cat) return;
        const valorAtual = metasPorCategoria[cat] || 0;
        const novoValorStr = prompt(`Meta de Gastos MENSAL para ${cat}:
Valor Atual: R$ ${valorAtual.toFixed(2)}
Digite o novo valor (0 para remover):`, valorAtual);
        if (novoValorStr !== null) {
            const novoValor = parseFloat(novoValorStr.replace(',', '.'));
            if (!isNaN(novoValor) && novoValor >= 0) {
                if (novoValor === 0) {
                    delete metasPorCategoria[cat];
                    alert(`✅ Meta para ${cat} removida.`);
                } else {
                    metasPorCategoria[cat] = novoValor;
                    alert(`✅ Meta para ${cat} definida em ${formatarMoeda(novoValor)}.`);
                }
                localStorage.setItem('metasPorCategoria', JSON.stringify(metasPorCategoria));
                atualizarCardsGlobais(registros); // Para recalcular e atualizar o resumo das metas
            } else {
                alert('❌ Valor inválido! Digite um número positivo ou zero.');
            }
        }
    }
}
// Sugestão 8: Resumo das Metas por Categoria
function atualizarCategoryMetas(dataList) {
    const summaryDiv = document.getElementById("categoryMetasSummary");
    summaryDiv.innerHTML = '';
    // Gasto Realizado do Mês (status 'Pago')
    const gastosMesPorCategoria = dataList.filter(r => r.tipo === "Pagar" && r.status === "Pago")
        .reduce((acc, r) => {
            const dataRegistro = new Date(r.data + 'T12:00:00');
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();
            if (dataRegistro.getMonth() === mesAtual && dataRegistro.getFullYear() === anoAtual) {
                acc[r.categoria] = (acc[r.categoria] || 0) + parseFloat(r.valor);
            }
            return acc;
        }, {});
    const categoriasComMeta = Object.keys(metasPorCategoria).sort();
    if (categoriasComMeta.length === 0) {
        summaryDiv.innerHTML = '<div style="text-align: center; color: #b0b0b0;">Clique no card acima para editar, ou <span style="cursor:pointer; color:var(--meta-color); font-weight:700;" onclick="editarMeta(\'category\')">defina metas por categoria</span>.</div>';
        return;
    }
    categoriasComMeta.forEach(cat => {
        const meta = metasPorCategoria[cat];
        const gasto = gastosMesPorCategoria[cat] || 0;
        const percentual = meta > 0 ? (gasto / meta * 100) : 0;
        const item = document.createElement('div');
        item.classList.add('category-progress-item');
        item.onclick = () => editarMeta('category');
        item.style.cursor = 'pointer';
        let progressClass = '';
        if (percentual >= 100) {
            progressClass = 'danger';
        } else if (percentual >= 80) {
            progressClass = 'warning';
        }
        item.innerHTML = `
            <div class="label">
                <span>${cat}</span>
                <span style="color: ${percentual > 100 ? 'var(--falta-color)' : 'var(--sobra-color)'};">
                    ${formatarMoeda(gasto)} / ${formatarMoeda(meta)} (${percentual.toFixed(0)}%)
                </span>
            </div>
            <div class="progress-bar" style="height: 6px;">
                <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentual, 100)}%;"></div>
            </div>
        `;
        summaryDiv.appendChild(item);
    });
}
// Sugestão 12: Calendário Financeiro
function renderizarCalendario(dataList) {
    const calDiv = document.getElementById('financialCalendar');
    calDiv.innerHTML = '<div class="calendar-header">Dom</div><div class="calendar-header">Seg</div><div class="calendar-header">Ter</div><div class="calendar-header">Qua</div><div class="calendar-header">Qui</div><div class="calendar-header">Sex</div><div class="calendar-header">Sáb</div>';
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = hoje.getMonth();
    document.getElementById('calendarHeader').innerText = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    const primeiroDia = new Date(ano, mes, 1);
    const ultimoDia = new Date(ano, mes + 1, 0);
    const diasNoMes = ultimoDia.getDate();
    const diaDaSemanaInicio = primeiroDia.getDay(); // 0 (Dom) a 6 (Sáb)
    // Preencher células vazias no início
    for (let i = 0; i < diaDaSemanaInicio; i++) {
        calDiv.innerHTML += '<div class="calendar-day" style="background:none; border:none;"></div>';
    }
    // Coletar eventos do mês
    const eventosDoMes = dataList.filter(r => {
        const dataReg = new Date(r.data + 'T12:00:00');
        return dataReg.getFullYear() === ano && dataReg.getMonth() === mes;
    }).reduce((acc, r) => {
        const dia = new Date(r.data + 'T12:00:00').getDate();
        if (!acc[dia]) acc[dia] = { pagar: 0, receber: 0, itens: [] };
        if (r.status === 'Pendente') { // Apenas pendentes para o calendário (lembretes)
            if (r.tipo === 'Pagar') acc[dia].pagar += parseFloat(r.valor);
            else if (r.tipo === 'Receber') acc[dia].receber += parseFloat(r.valor);
            acc[dia].itens.push(r);
        }
        return acc;
    }, {});
    // Preencher dias do mês
    for (let dia = 1; dia <= diasNoMes; dia++) {
        const diaDiv = document.createElement('div');
        diaDiv.classList.add('calendar-day');
        if (eventosDoMes[dia] && (eventosDoMes[dia].pagar > 0 || eventosDoMes[dia].receber > 0)) {
            diaDiv.classList.add('day-has-events');
            diaDiv.onclick = () => {
                const itens = eventosDoMes[dia].itens.map(i => `${i.tipo}: ${i.descricao} (${formatarMoeda(i.valor)})`).join('\n');
                alert(`Lançamentos para ${dia}/${mes+1}:\n${itens}`);
            };
        }
        let diaHtml = `<span class="calendar-day-number">${dia}</span>`;
        if (eventosDoMes[dia]) {
            if (eventosDoMes[dia].pagar > 0) {
                diaHtml += `<div class="day-pagar">P: ${formatarMoeda(eventosDoMes[dia].pagar)}</div>`;
                // Sugestão 11: Avisos de contas próximas do vencimento (simplificado)
                const dataVenc = new Date(ano, mes, dia);
                const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                if (diffDias >= 0 && diffDias <= 3) {
                    // console.log(`Alerta: Contas a pagar vencem em ${diffDias} dias!`);
                }
            }
            if (eventosDoMes[dia].receber > 0) {
                diaHtml += `<div class="day-receber">R: ${formatarMoeda(eventosDoMes[dia].receber)}</div>`;
            }
        }
        diaDiv.innerHTML = diaHtml;
        calDiv.appendChild(diaDiv);
    }
}
// Novo: Sugestão 18 - Lógica de Pagamento Parcial
function pagamentoParcial(row) {
    const registro = registros.find(r => r.row === row);
    if (!registro || registro.tipo !== 'Pagar' || registro.status !== 'Pendente') return;
    const valorOriginal = registro.valorOriginal || parseFloat(registro.valor);
    const valorAtual = parseFloat(registro.valor);
    const valorPagoStr = prompt(`Pagamento Parcial para:
${registro.descricao} - ${formatarMoeda(valorAtual)}
Digite o valor a pagar (máx: ${formatarMoeda(valorAtual)}):`);
    if (valorPagoStr === null) return;
    const valorPago = parseFloat(valorPagoStr.replace(',', '.'));
    if (isNaN(valorPago) || valorPago <= 0) {
        alert("❌ Valor inválido.");
        return;
    }
    if (valorPago > valorAtual) {
        alert("❌ O valor pago não pode ser maior que o saldo devedor.");
        return;
    }
    const novoValorRestante = valorAtual - valorPago;
    if (novoValorRestante <= 0.01) { // Considera pago se o restante for mínimo
        registro.valor = 0;
        registro.status = 'Pago';
        registro.valorOriginal = valorOriginal; 
        alert(`✅ ${formatarMoeda(valorPago)} pago. Registro marcado como 'Pago'.`);
    } else {
        registro.valor = novoValorRestante.toFixed(2);
        registro.valorOriginal = valorOriginal; 
        alert(`✅ ${formatarMoeda(valorPago)} pago. Saldo restante: ${formatarMoeda(novoValorRestante)}.`);
    }
    // Envia a alteração para a planilha
    enviarParaPlanilha({...registro, action:'update', campo1: registro.categoria});
    aplicarFiltros(); 
}
function mudarStatus(row) {
  const registro = registros.find(r => r.row === row);
  if(!registro) return;
  let novoStatus = registro.status;
  if(registro.status === "Pendente") {
    // Para marcar como Pago/Recebido, o valor deve ser o valor total original
    novoStatus = registro.tipo === "Pagar" ? "Pago" : "Recebido";
    if (registro.valorOriginal && parseFloat(registro.valorOriginal) > parseFloat(registro.valor)) {
        // Se houver saldo parcial, pergunta se quer pagar o restante
        if (!confirm(`O saldo devedor é ${formatarMoeda(parseFloat(registro.valor))}. Deseja marcar como '${novoStatus}' (assumindo que o restante foi pago)?`)) {
            return;
        }
    }
    // Ao marcar como Pago/Recebido, reseta o valor para o valorOriginal para a planilha, e zera o valor do registro.
    if (registro.valorOriginal) {
        registro.valor = registro.valorOriginal;
    }
    registro.valorOriginal = null; // Reseta o controle parcial
  } else {
    // Ao reverter, o valor volta ao que era, mas sem valorOriginal
    novoStatus = "Pendente";
    registro.valorOriginal = null;
  }
  registro.status = novoStatus;
  enviarParaPlanilha({...registro, action:'update', campo1: registro.categoria});
  aplicarFiltros(); 
}
function exportarExcel(){
    // ... (Lógica de filtro de exportação, mantida a original para brevidade) ...
    const termo = document.getElementById("buscar").value.toLowerCase();
    const periodoSelecionado = document.getElementById("filtroPeriodo").value; 
    let dataInicioStr = document.getElementById("dataInicio").value;
    let dataFimStr = document.getElementById("dataFim").value;
    const diasCustomizados = document.getElementById("diasCustomizados").value;
    const categoriaFiltro = document.getElementById("filtroCategoria").value;
    let listaExportar = registros;
    let dataFiltroAtivo = false;
    let dataInicioFiltro, dataFimFiltro;
    if (periodoSelecionado !== 'all') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 
        dataFimFiltro = new Date();
        dataFimFiltro.setHours(23, 59, 59, 999);
        if (periodoSelecionado === '1') {
            dataInicioFiltro = hoje;
        } else if (periodoSelecionado === '2-30') {
            const inicio = new Date(hoje);
            inicio.setDate(hoje.getDate() - 30);
            dataInicioFiltro = inicio; 
            const ontem = new Date(hoje);
            ontem.setDate(hoje.getDate() - 1); 
            dataFimFiltro = new Date(ontem.toISOString().split('T')[0] + 'T23:59:59'); 
        } else if (periodoSelecionado === 'customDays' && diasCustomizados) {
            const dias = parseInt(diasCustomizados);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1));
            } else {
                dataFiltroAtivo = false;
            }
        } else {
            const dias = parseInt(periodoSelecionado);
            if (!isNaN(dias) && dias > 0) {
                dataInicioFiltro = new Date(hoje);
                dataInicioFiltro.setDate(hoje.getDate() - (dias - 1)); 
            }
        }
        if (dataInicioFiltro && dataFimFiltro) {
            dataFiltroAtivo = true;
        }
    }
    if (dataInicioStr && dataFimStr) {
        dataInicioFiltro = new Date(corrigirData(dataInicioStr) + 'T00:00:00');
        dataFimFiltro = new Date(corrigirData(dataFimStr) + 'T23:59:59'); 
        dataFiltroAtivo = true;
    }
    if (dataFiltroAtivo) {
        listaExportar = listaExportar.filter(r => {
            const dataRegistro = new Date(r.data + 'T12:00:00'); 
            return dataRegistro >= dataInicioFiltro && dataRegistro <= dataFimFiltro;
        });
    }
    if (filtroStatusAtual !== 'todos') {
        if (filtroStatusAtual === 'tipo-pagar') {
            listaExportar = listaExportar.filter(r => r.tipo === 'Pagar');
        } else if (filtroStatusAtual === 'tipo-receber') {
            listaExportar = listaExportar.filter(r => r.tipo === 'Receber');
        } else {
            listaExportar = listaExportar.filter(r => r.status === filtroStatusAtual);
        }
    }
    if (mostraApenasFav) {
        listaExportar = listaExportar.filter(r => r.fav);
    }
    if (categoriaFiltro !== 'all') {
        listaExportar = listaExportar.filter(r => r.categoria === categoriaFiltro);
    }
    if (termo) {
        listaExportar = listaExportar.filter(r => 
            r.descricao.toLowerCase().includes(termo) || 
            r.tipo.toLowerCase().includes(termo) || 
            r.categoria.toLowerCase().includes(termo) ||
            r.conta.toLowerCase().includes(termo) ||
            r.data.includes(termo)
        );
    }
  const ws_data=listaExportar.map(r=>[
    r.fav?"★":"",
    new Date(r.data + 'T12:00:00').toLocaleDateString('pt-BR'),
    r.tipo,
    r.descricao,
    r.categoria || '-',
    r.valor,
    r.valorOriginal ? r.valorOriginal : '', // Valor Original (para parciais)
    r.status,
    r.conta || 'N/A', 
    r.recorrente, 
    r.parcelaTotal > 1 ? `${r.parcelaAtual}/${r.parcelaTotal}` : '', 
    r.campo2||'',
    r.campo3||''
  ]);
  ws_data.unshift(["Fav","Data","Tipo","Descrição","Categoria","Valor","Valor Original","Status","Conta","Recorrente","Parcelas","Campo2","Campo3"]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Financeiro");
  XLSX.writeFile(wb,"Controle_Financeiro_Avançado.xlsx");
}
function editar(row){
  const r=registros.find(r=>r.row===row);
  if(r){
    document.getElementById("row").value=r.row;
    document.getElementById("sheetRowId").value=r.id;
    document.getElementById("data").value=r.data;
    document.getElementById("tipo").value=r.tipo;
    // Se for edição de um parcial, o valor exibido é o restante (valor)
    document.getElementById("valor").value=r.valor; 
    document.getElementById("status").value=r.status;
    document.getElementById("descricao").value=r.descricao.replace(/\s\(\d+\/\d+\)$/, ''); // Remove a marcação de parcela na edição
    document.getElementById("categoria").value=r.categoria || '';
    document.getElementById("conta").value=r.conta || 'Conta Corrente';
    document.getElementById("recorrencia").value=r.recorrente || 'Nao';
    document.getElementById("parcelas").value=r.parcelaTotal || 1;
    toggleParcelaRecorrente(); // Atualiza a visibilidade e estado
    document.getElementById("campo2").value=r.campo2||'';
    document.getElementById("campo3").value=r.campo3||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }
}
function excluir(row){
  if(confirm("Deseja excluir este registro?")){
    const r = registros.find(r=>r.row===row);
    const idx = registros.findIndex(r=>r.row===row);
    enviarParaPlanilha({...r,action:'delete'});
    registros.splice(idx,1);
    mostraApenasFav = false;
    document.getElementById("btnFiltrarFav").classList.remove("active");
    aplicarFiltros();
  }
}
function toggleFav(row){
  const idx = registros.findIndex(r=>r.row===row);
  registros[idx].fav=!registros[idx].fav;
  enviarParaPlanilha({...registros[idx],action:'update'});
  aplicarFiltros();
}
// Sugestão 28: Auto-preenchimento de categoria
document.getElementById("descricao").addEventListener("input", function() {
    const categoriaAtual = document.getElementById("categoria").value;
    if (!categoriaAtual || categoriaAtual === 'Selecione a Categoria') {
        const categoriaSugerida = aplicarRegrasAutomacao(this.value, null);
        if (categoriaSugerida) {
            document.getElementById("categoria").value = categoriaSugerida;
        }
    }
});
// Novo: Sugestão 25 - Lógica do FAB
function toggleQuickMenu() {
    document.getElementById('quickMenu').classList.toggle('visible');
}
function focarFormulario(tipo) {
    document.getElementById("tipo").value = tipo;
    toggleParcelaRecorrente();
    document.getElementById("descricao").focus();
    toggleQuickMenu(); // Fecha o menu
    window.scrollTo({top: 0, behavior: 'smooth'});
}
document.addEventListener('keydown', (e) => {
    // Removida a verificação de autenticação
    if (e.key === '+' || e.key.toLowerCase() === 'n') {
        e.preventDefault();
        document.getElementById("descricao").focus();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
});
document.getElementById("data").valueAsDate=new Date();
// Inicialização direta
applyTheme();
toggleParcelaRecorrente(); // Define o estado inicial
atualizarCardObjetivo(); // Inicializa o card de objetivo
carregarRegistros(); // Carrega registros imediatamente
setInterval(() => {
  carregarRegistros();
  console.log("↻ Sincronizando...");
}, 10000);
</script>
</body>
</html>
